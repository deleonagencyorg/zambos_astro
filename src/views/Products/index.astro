---
// src/components/pages/ProductsPage.astro
import { t } from '../../i18n/i18n';
import type { Locale } from '../../i18n/i18n';
import { getLocale } from '../../i18n/i18n';
import './styles.css';
import Subscription from '../../components/subscription/index.astro';

const currentLang = getLocale();
const products = t('items', { namespace: 'products', locale: currentLang });
const categories = t('categories', { namespace: 'products', locale: currentLang });
const pageAssets = t('page', { namespace: 'products', locale: currentLang });

// Obtener categorías únicas de los productos
const uniqueCategories = Object.keys(categories);

// Categorías que son nuevas (mostrar badge NUEVO)
const newCategories = ['yuquita']; // Ajusta según necesites
---

<div class="products-page min-h-screen bg-[#00A650] relative overflow-hidden">
  <!-- Decoración superior izquierda (imagen de plátano/chip) -->
  <!-- <div class="absolute top-0 left-0 w-32 h-32 md:w-48 md:h-48 pointer-events-none z-20">
    <img 
      src="/images/decorations/platano-decoration.png" 
      alt="" 
      class="w-full h-full object-contain"
      aria-hidden="true"
    />
  </div> -->

  <div class="container mx-auto px-4 py-12 relative z-10">
    <!-- Encabezado -->
    <div class="text-center mb-8">
      <h1 class="text-5xl md:text-7xl font-black italic text-white mb-3 tracking-wide font-title">
        {currentLang === 'es' ? 'PRODUCTOS' : 'PRODUCTS'}
      </h1>
      <p class="text-white text-lg md:text-xl italic">
        {currentLang === 'es' ? 'Descubre toda nuestra variedad de sabores' : 'Discover our wide variety of flavors'}
      </p>
    </div>
    
    <!-- Filtro de categorías -->
    <div class="flex flex-wrap justify-center mb-10 gap-3">
      <!-- Botón TODOS LOS PRODUCTOS - Borde verde, fondo blanco -->
      <button 
        type="button" 
        class="category-filter category-filter--all active px-8 py-3 rounded-full text-sm font-bold transition-all duration-300 uppercase tracking-wide"
        data-category="all"
      >
        {currentLang === 'es' ? 'TODOS LOS PRODUCTOS' : 'ALL PRODUCTS'}
      </button>
    </div>
    
    {products.length === 0 ? (
      <p class="text-center text-white text-lg">{currentLang === 'es' ? 'No hay productos disponibles' : 'No products available'}</p>
    ) : (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto" id="products-grid">
        {products.map((product: any) => (
          <div 
            class="product-card bg-[#FFF176] rounded-3xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 relative" 
            data-category={product.category} 
            transition:animate="fade"
          >
            <!-- Badge de categoría -->
            <div class="absolute top-4 right-4 z-10">
              <span class="bg-[#E31E24] text-white text-xs px-4 py-1.5 rounded-full font-bold uppercase">
                {categories[product.category] || product.category}
              </span>
            </div>

            <!-- Imagen del producto -->
            <div class="relative h-72 md:h-80 flex items-center justify-center p-6 overflow-hidden">
              <img 
                src={product.image || '/images/products/placeholder.jpg'} 
                alt={product.name || product.title} 
                class="max-h-full max-w-full object-contain drop-shadow-xl transition-transform duration-300 hover:scale-105"
                transition:name={`product-image-${product.id}`}
              />
            </div>

            <!-- Contenido -->
            <div class="px-6 pb-6">
              <h3 class="text-xl font-black text-black mb-3 uppercase leading-tight tracking-wide">
                {product.name || product.title}
              </h3>
              <p class="text-gray-700 text-sm mb-5 line-clamp-2 min-h-[44px] leading-relaxed">
                {product.short_description || product.description}
              </p>
              
              <!-- Botón Ver Detalle - VERDE -->
              <a 
                href={`/${currentLang}/productos/${product.id}`} 
                class="block w-full bg-[#00A650] hover:bg-[#008C44] text-white text-center py-4 rounded-xl font-bold text-sm uppercase tracking-wider transition-colors duration-300"
              >
                {pageAssets?.view_details || 'VER DETALLE'}
              </a>
            </div>
          </div>
        ))}
      </div>
    )}
  </div>
  <section class="w-full">
    <Subscription />
  </section>
</div>

<style>
  /* Botón TODOS LOS PRODUCTOS - Borde verde, fondo blanco */
  .category-filter--all {
    background-color: white;
    border: 2px solid #00A650;
    color: #00A650;
  }
  
  .category-filter--all:hover {
    background-color: #f0fff4;
  }
  
  .category-filter--all.active {
    background-color: white;
    border-color: #00A650;
    color: #00A650;
  }

  /* Botones de categoría normal - Verde sólido */
  .category-filter--normal {
    background-color: #00A650;
    border: 2px solid #00A650;
    color: white;
  }
  
  .category-filter--normal:hover {
    background-color: #008C44;
    border-color: #008C44;
  }
  
  .category-filter--normal.active {
    background-color: #008C44;
    border-color: #008C44;
  }

  /* Botones de categoría nueva - Gris oscuro */
  .category-filter--new {
    background-color: #4A5568;
    border: 2px solid #4A5568;
    color: white;
  }
  
  .category-filter--new:hover {
    background-color: #2D3748;
    border-color: #2D3748;
  }
  
  .category-filter--new.active {
    background-color: #2D3748;
    border-color: #2D3748;
  }

  /* Animación para las cards */
  .product-card {
    animation: fadeInUp 0.5s ease-out forwards;
    opacity: 0;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Delay escalonado para las cards */
  .product-card:nth-child(1) { animation-delay: 0.1s; }
  .product-card:nth-child(2) { animation-delay: 0.15s; }
  .product-card:nth-child(3) { animation-delay: 0.2s; }
  .product-card:nth-child(4) { animation-delay: 0.25s; }
  .product-card:nth-child(5) { animation-delay: 0.3s; }
  .product-card:nth-child(6) { animation-delay: 0.35s; }
  .product-card:nth-child(7) { animation-delay: 0.4s; }
  .product-card:nth-child(8) { animation-delay: 0.45s; }
  .product-card:nth-child(9) { animation-delay: 0.5s; }
  .product-card:nth-child(10) { animation-delay: 0.55s; }
  .product-card:nth-child(11) { animation-delay: 0.6s; }
  .product-card:nth-child(12) { animation-delay: 0.65s; }

  /* Line clamp para descripción */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Fix para las imágenes que no cargan
  document.addEventListener('DOMContentLoaded', () => {
    const images = document.querySelectorAll('img');
    images.forEach(img => {
      img.addEventListener('error', function() {
        this.src = '/images/products/placeholder.jpg';
      });
    });
    
    // Filtro de categorías
    const filterButtons = document.querySelectorAll('.category-filter');
    const productCards = document.querySelectorAll('.product-card');
    
    filterButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Actualizar estado activo de los botones
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        const category = button.getAttribute('data-category') || 'all';
        
        // Filtrar productos con animación
        let visibleIndex = 0;
        productCards.forEach((cardEl) => {
          const card = cardEl as HTMLElement;
          const cardCategory = card.getAttribute('data-category');
          
          if (category === 'all' || cardCategory === category) {
            card.style.display = 'block';
            // Re-trigger animation
            card.style.animation = 'none';
            card.offsetHeight; // Trigger reflow
            card.style.animation = `fadeInUp 0.5s ease-out forwards`;
            card.style.animationDelay = `${visibleIndex * 0.05}s`;
            visibleIndex++;
          } else {
            card.style.display = 'none';
          }
        });
      });
    });
  });
</script>