---
// src/views/Products/Detail/index.astro
import { t } from '../../../i18n/i18n';
import type { Locale } from '../../../i18n/i18n';
import './styles.css';
import { initProductDetail } from './scripts.js';
import ProductsCarousel from '../../../components/common/ProductsCarousel/index.astro';
import LazyImage from '../../../components/common/LazyImage.astro';
import Subscription from '../../../components/subscription/index.astro';
import ExperiencesCarousel from '../../../components/common/Experiences/index.astro';
import RecipesCarousel from '../../../components/recipes/RecipesCarousel.astro';

// Interfaces locales
interface ProductSize {
  value: string;
  image: string;
}

interface Recipe {
  id: string;
  title: string;
  image?: string;
  preparation_time: number;
  type?: string;
  category?: string;
  isNew?: boolean;
  description?: string;
}

interface Stockist {
  id: string;
  name: string;
  icon: string;
  link: string;
}

interface Product {
  id: string;
  name: string;
  image: string;
  available?: string;
  background_image: string;
  background_color: string;
  header_text_color: string;
  color_button: string;
  sizes: ProductSize[];
  description?: string;
  short_description?: string;
  nutrition?: any;
  presentaciones?: Array<{
    value: string;
    icono: string;
  }>;
  // relatedProducts es opcional ya que no existe en la estructura actual
  relatedProducts?: string[];
  weight?: string[];
}

const { currentLang, productId } = Astro.props;

// Obtener datos desde traducciones
const productsAssets = t('home', { namespace: 'products', locale: currentLang }) || {};
const products = t('items', { namespace: 'products', locale: currentLang as Locale }) || [];
const stockists = t('stockist', { namespace: 'products', locale: currentLang as Locale }) || [];
const product = products.find((item: Product) => item.id === productId);
const brandsAssets = t('', { namespace: 'brands', locale: currentLang }) || {};
const newsAssets =  t('', { namespace: 'news', locale: currentLang }) || {};
const brandsList = brandsAssets.brands || [];
const zambosBrand = brandsList.find((brand: any) => brand.id === 'Zambos');
const zambosProducts = (zambosBrand?.products || []).filter((product: any) => product.id !== productId);
const experiences = t('experiences', { namespace: 'experiences', locale: currentLang }) || [];

// Recetas (mismo origen que src/views/Recipes)
const recipeModules = import.meta.glob<{ default: Recipe }>("../../../locales/*/recipes/*.json");
const recommendedRecipes: Recipe[] = [];
for (const path in recipeModules) {
  const parts = path.split('/');
  const localesIdx = parts.lastIndexOf('locales');
  const lang = localesIdx >= 0 ? parts[localesIdx + 1] : '';
  if (lang === currentLang) {
    const mod = await recipeModules[path]();
    recommendedRecipes.push(mod.default);
  }
}

// Limitar cantidad para el carrusel
const recommendedRecipesSlice = recommendedRecipes
  .filter((r) => r && typeof r.id === 'string')
  .slice(0, 8);

// Si el producto no existe, lanzar error
if (!product || Object.keys(product).length === 0) {
  throw new Error(t('errors.product_not_found', { locale: currentLang }));
}

// Asegurar que todas las propiedades necesarias existan
const safeProduct: Product = {
  id: product.id || '',
  name: product.name || '',
  image: product.image || '',
  background_image: product.background_color || '',
  background_color: product.background_color || '',
  header_text_color: product.header_text_color || '#000000',
  color_button: product.color_button || '#000000',
  sizes: Array.isArray(product.sizes) ? product.sizes : [],
  available: product.available || '',
  description: product.description || '',
  nutrition: (product as any).nutrition,
  weight: Array.isArray(product.weight) ? product.weight : [],
  
};

function hasNutrition(nutrition: any): boolean {
  if (nutrition === undefined || nutrition === null) return false;
  if (typeof nutrition === 'string') return nutrition.trim().length > 0;
  if (Array.isArray(nutrition)) return nutrition.length > 0;
  if (typeof nutrition === 'object') return Object.keys(nutrition).length > 0;
  return false;
}

const nutritionData = safeProduct.nutrition;
const nutritionIsString = typeof nutritionData === 'string';
const nutritionIsArray = Array.isArray(nutritionData);
const nutritionIsObject =
  !!nutritionData && typeof nutritionData === 'object' && !Array.isArray(nutritionData);
const nutritionEntries = nutritionIsObject ? Object.entries(nutritionData) : [];

// Obtener todos los productos como un array
const productsData = t('items', { locale: currentLang, namespace: 'products' }) || [];
const allProductsArray = Array.isArray(productsData) ? productsData : [];

// Filtrar productos relacionados - simplificado para evitar errores
let relatedProducts: any[] = [];
// Solo usar productos de la misma categoría si hay más de 1 producto
if (allProductsArray.length > 1) {
  relatedProducts = allProductsArray
    .filter((p: any) => p.id !== productId)
    .slice(0, 3);
}

---

{safeProduct.background_color && (
  <article
    id="product-detail"
    class="product-detail min-h-screen relative overflow-hidden"
    style={{ backgroundColor: '#0DB04A' }}
    transition:animate="slide"
  >
    <div class="container mx-auto px-6 md:px-12 py-8 md:py-16">
      <!-- Enlace "Ir a Productos" -->
      <a 
        href={`/${currentLang}/products`} 
        class="inline-flex items-center text-sm md:text-base font-medium mb-6 hover:opacity-80 transition-opacity"
        style={{ color: '#FFF' }}
      >
        {currentLang === 'es' ? 'Ir a Productos' : 'Go to Products'}
      </a>

      <div class="flex flex-col lg:flex-row items-center lg:items-start gap-8 lg:gap-16">
        <!-- Contenido del lado izquierdo -->
        <div class="w-full lg:w-1/2 order-2 lg:order-1">
          <!-- Título del producto -->
          <h1 
            class="text-4xl md:text-5xl lg:text-6xl font-bold italic leading-tight mb-8"
            style={{ color: '#FFF' }}
          >
            {safeProduct.name}
          </h1>

        <div class="hidden lg:block absolute top-[70px] left-[800px]">
          <svg width="607" height="525" viewBox="0 0 607 525" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M49.6617 48.914C49.5758 48.9742 49.4865 48.9962 49.4171 48.9928C49.362 48.9901 49.2824 48.9716 49.183 48.8712L24.8946 24.3455C24.7385 24.1879 24.7486 23.9282 24.9165 23.7827L34.8154 15.2104C35.0071 15.0444 35.3017 15.1121 35.4033 15.3457L49.793 48.4438C49.8495 48.574 49.8389 48.6562 49.8217 48.7095C49.8001 48.7767 49.7476 48.8537 49.6617 48.914Z" stroke="white" stroke-opacity="0.4" stroke-width="2.27696"/>
            <path d="M494.031 374.583C493.949 374.518 493.903 374.438 493.886 374.37C493.873 374.317 493.869 374.235 493.937 374.112L523.845 319.994C523.952 319.8 524.204 319.737 524.391 319.857L544.118 332.549C544.331 332.686 544.349 332.987 544.154 333.15L494.519 374.577C494.41 374.667 494.328 374.68 494.272 374.679C494.201 374.677 494.113 374.648 494.031 374.583Z" stroke="white" stroke-opacity="0.4" stroke-width="2.27696"/>
            <path d="M43.473 513.681C43.3839 513.737 43.2935 513.754 43.2244 513.747C43.1695 513.741 43.0911 513.718 42.9973 513.613L1.93482 467.384C1.78751 467.218 1.8117 466.96 1.98726 466.823L20.526 452.452C20.7264 452.297 21.0162 452.38 21.1052 452.618L43.6295 513.219C43.6789 513.352 43.6638 513.433 43.6438 513.486C43.6186 513.552 43.5619 513.626 43.473 513.681Z" stroke="white" stroke-opacity="0.4" stroke-width="2.27696"/>
            <path d="M63.2413 40.6892C63.138 40.7075 63.0485 40.6892 62.9887 40.6563C62.9413 40.6303 62.879 40.5789 62.8361 40.4441L51.836 5.87232C51.769 5.66171 51.8944 5.42911 52.108 5.36863L65.2086 1.66095C65.4519 1.59215 65.6812 1.77904 65.6674 2.03488L63.5679 40.315C63.56 40.4586 63.5132 40.5293 63.4743 40.5706C63.4252 40.6226 63.3444 40.6709 63.2413 40.6892Z" stroke="white" stroke-opacity="0.4" stroke-width="2.27696"/>
            <path d="M511.548 390.145C511.501 390.051 511.494 389.96 511.508 389.893C511.52 389.84 511.553 389.766 511.67 389.687L565.335 353.487C565.518 353.364 565.777 353.419 565.895 353.607L578.823 374.174C578.958 374.388 578.842 374.661 578.593 374.72L511.999 390.353C511.859 390.385 511.778 390.36 511.727 390.335C511.664 390.302 511.595 390.238 511.548 390.145Z" stroke="white" stroke-opacity="0.4" stroke-width="2.27696"/>
            <path d="M63.9838 502.349C63.8797 502.362 63.7913 502.339 63.7333 502.303C63.6874 502.274 63.6289 502.219 63.5934 502.082L47.3396 439.423C47.2842 439.209 47.422 438.984 47.6385 438.935L71.3377 433.597C71.5845 433.541 71.8036 433.741 71.7757 433.996L64.3302 501.993C64.3146 502.137 64.264 502.204 64.2229 502.244C64.171 502.293 64.0879 502.337 63.9838 502.349Z" stroke="white" stroke-opacity="0.4" stroke-width="2.27696"/>
            <path d="M539.435 53.2855C539.336 53.2481 539.266 53.1865 539.229 53.1271C539.2 53.0802 539.17 53.0034 539.195 52.8624L548.557 1.98235C548.597 1.76449 548.815 1.6269 549.029 1.68423L567.023 6.50575C567.266 6.57084 567.38 6.85005 567.251 7.06626L539.895 53.1245C539.821 53.2477 539.748 53.2855 539.695 53.3017C539.628 53.3222 539.535 53.3228 539.435 53.2855Z" stroke="white" stroke-opacity="0.6" stroke-width="2.27696"/>
            <path d="M557.493 61.7014C557.42 61.6243 557.386 61.5381 557.379 61.4684C557.373 61.4134 557.379 61.3311 557.464 61.2161L589.239 18.0996C589.37 17.9212 589.626 17.8929 589.793 18.0385L604.623 30.954C604.814 31.1196 604.792 31.4219 604.581 31.5591L557.976 61.7594C557.856 61.8371 557.773 61.8394 557.718 61.8305C557.649 61.8192 557.565 61.7784 557.493 61.7014Z" stroke="white" stroke-opacity="0.6" stroke-width="2.27696"/>
          </svg>
        </div>


          <!-- Botones de peso/presentaciones -->
          {safeProduct.weight && safeProduct.weight.length > 0 && (
            <div class="flex flex-wrap gap-3 mb-10">
              {safeProduct.weight.map((weight) => (
                <button 
                  class="px-10 py-4 rounded-full text-white font-semibold text-sm md:text-base hover:opacity-90 transition-opacity"
                  style={{ backgroundColor: '#FF0001' }}
                >
                  {weight}
                </button>
              ))}
            </div>
          )}

          <!-- Sección Descripción (Acordeón) -->
          <div class="border-t py-4" style={{ borderColor: `${safeProduct.header_text_color}40` }}>
            <button 
              class="accordion-trigger w-full flex justify-between items-center text-left"
              data-accordion="description"
              style={{ color: '#FFF' }}
            >
              <span class="text-2xl sm:text-3xl md:text-4xl font-semibold">
                {currentLang === 'es' ? 'Descripción' : 'Description'}
              </span>
              <span class="accordion-icon text-4xl font-light transition-transform duration-300">−</span>
            </button>
            <div class="accordion-content overflow-hidden transition-all duration-300 max-h-96" data-content="description">
              <p 
                class="pt-4 text-base md:text-lg leading-relaxed"
                style={{ color: '#FFF' }}
              >
                {safeProduct.description}
              </p>
            </div>
          </div>

          <!-- Sección Datos Nutricionales (Acordeón) -->
          {hasNutrition(safeProduct.nutrition) && (
            <div class="border-t border-b py-4" style={{ borderColor: `${safeProduct.header_text_color}40` }}>
              <button 
                class="accordion-trigger w-full flex justify-between items-center text-left"
                data-accordion="nutrition"
              >
                <span class="text-2xl sm:text-3xl md:text-4xl font-semibold text-white">
                  {currentLang === 'es' ? 'Datos nutricionales' : 'Nutritional information'}
                </span>
                <span class="accordion-icon text-4xl font-light transition-transform duration-300 text-white">+</span>
              </button>
              <div class="accordion-content overflow-hidden transition-all duration-300 max-h-0" data-content="nutrition">
                <div 
                  class="pt-4 text-base md:text-lg leading-relaxed text-white"
                >
                  {nutritionIsString && <p>{nutritionData}</p>}

                  {nutritionIsArray && (
                    <div class="space-y-2">
                      {(nutritionData as any[]).map((row: any) => (
                        <p>{typeof row === 'string' ? row : JSON.stringify(row)}</p>
                      ))}
                    </div>
                  )}

                  {nutritionEntries.length > 0 && (
                    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                      {nutritionEntries.map(([key, value]) => (
                        <div>
                          <dt class="font-semibold">{key}</dt>
                          <dd class="opacity-90">{String(value)}</dd>
                        </div>
                      ))}
                    </dl>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>

        <!-- Imagen del producto (lado derecho) -->
        <div class="w-full lg:w-1/2 order-1 lg:order-2 flex justify-center items-center">
          <div class="relative">
            <img 
              id="product-image" 
              class="max-w-full h-auto w-[300px] md:w-[400px] lg:w-[400px] object-contain drop-shadow-2xl transition-transform duration-500 hover:scale-105" 
              src={safeProduct.image} 
              alt={safeProduct.name} 
              transition:name={`product-image-${safeProduct.id}`} 
            />
          </div>
        </div>
      </div>
    </div>

    <section id="product-detail-experiences" data-country-target class="hidden">
      <ExperiencesCarousel 
        experiences={experiences}
        mainTitleColor='#FFF'
        backgroundColor='#FF0001'
        textColor='#FFF'
        buttonColor='#FFF'
        textButtonColor='#FF0001'
      />
    </section>

    <section id="product-detail-recipes" data-country-target class="hidden bg-red w-full py-16">
      <div class="container mx-auto px-6 md:px-12">
        <h2 class="text-white titles text-2xl md:text-4xl mb-8 text-center">
          {currentLang === 'es' ? 'Recetas Recomendadas' : 'Recommended Recipes'}
        </h2>

        {recommendedRecipesSlice.length ? (
          <RecipesCarousel items={recommendedRecipesSlice} />
        ) : (
          <div class="w-full flex justify-center">
            <p class="text-white/90 text-center font-semibold">
              {currentLang === 'es'
                ? 'No hay recetas disponibles en este momento.'
                : 'No recipes available at the moment.'}
            </p>
          </div>
        )}
      </div>
    </section>

    <section class="w-full">
      <Subscription />
    </section>
  </article>
)}

<script>
  import { initProductDetail } from './scripts.js';

  function initProductDetailPage() {
    const root = document.getElementById('product-detail');
    if (!root) return;

    if (root.dataset.productDetailInitialized === 'true') return;
    root.dataset.productDetailInitialized = 'true';

    initProductDetail();

    const descriptionTrigger = root.querySelector('[data-accordion="description"]');
    const descriptionContent = root.querySelector('[data-content="description"]');
    const descriptionIcon = descriptionTrigger?.querySelector('.accordion-icon');
    if (descriptionContent && descriptionIcon) {
      descriptionContent.classList.remove('max-h-0');
      descriptionContent.classList.add('max-h-96');
      descriptionIcon.textContent = '−';
      descriptionIcon.classList.remove('rotate-45');
    }

    const accordionTriggers = root.querySelectorAll('.accordion-trigger');
    accordionTriggers.forEach((trigger) => {
      trigger.addEventListener('click', () => {
        const accordionId = trigger.getAttribute('data-accordion');
        if (!accordionId) return;
        const content = root.querySelector(`[data-content="${accordionId}"]`);
        const icon = trigger.querySelector('.accordion-icon');

        if (content && icon) {
          const isOpen = content.classList.contains('max-h-96');
          if (isOpen) {
            content.classList.remove('max-h-96');
            content.classList.add('max-h-0');
            icon.textContent = '+';
            icon.classList.remove('rotate-45');
          } else {
            content.classList.remove('max-h-0');
            content.classList.add('max-h-96');
            icon.textContent = '−';
            icon.classList.remove('rotate-45');
          }
        }
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProductDetailPage);
  } else {
    initProductDetailPage();
  }

  document.addEventListener('astro:page-load', initProductDetailPage);
  document.addEventListener('astro:after-swap', initProductDetailPage);
</script>

<script type="module">
  async function applyCountryBlocks() {
    const experiences = document.getElementById('product-detail-experiences');
    const recipes = document.getElementById('product-detail-recipes');

    if (!experiences || !recipes) return;

    try {
      const response = await fetch('/api/geo-headers', { cache: 'no-store' });
      const geo = response.ok ? await response.json() : null;
      const isHonduras = geo?.country === 'HN';

      experiences.classList.toggle('hidden', !isHonduras);
      recipes.classList.toggle('hidden', isHonduras);
    } catch (e) {
      experiences.classList.add('hidden');
      recipes.classList.remove('hidden');
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyCountryBlocks);
  } else {
    applyCountryBlocks();
  }
  document.addEventListener('astro:page-load', applyCountryBlocks);
  document.addEventListener('astro:after-swap', applyCountryBlocks);
</script>

<style>
  .accordion-content {
    transition: max-height 0.3s ease-out;
  }
  
  .accordion-icon {
    transition: transform 0.3s ease;
  }
  
  .rotate-45 {
    transform: rotate(45deg);
  }
</style>