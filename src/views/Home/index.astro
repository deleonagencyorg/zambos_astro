---
import LazyImage from "../../components/common/LazyImage.astro";
// Component Imports
import VideoCarousel from "../../components/common/VideoCarousel/index.astro";
import RecipesCarousel from "../../components/recipes/RecipesCarousel.astro";
import ProductsCarousel from "../../components/common/ProductsCarousel/index.astro";
import MasonryGallery from "../../components/gallery/MasonryGallery.astro";
import PixelGrid from "../../components/atoms/PixelGrid.astro";
import BlogCard from "../../components/blog/BlogCard.astro";
import ExperiencesCarousel from "../../components/common/Experiences/index.astro";
import Subscription from "../../components/subscription/index.astro";
import Discover from "../../components/common/Discover/index.astro";

// Style Imports
import "./styles.css";

// i18n and Data Imports
import { t, getLocale } from "../../i18n/i18n";
import { InstagramEmbed } from "react-social-media-embed";

// Props
export interface Props {
  loading?: boolean;
}
const { loading = false } = Astro.props;

// Language and Data Setup
const currentLang = getLocale();
const homeAssets =
  t("home", { namespace: "common", locale: currentLang }) || {};
const recipesAssets =
  t("", { namespace: "recipes", locale: currentLang }) || {};
const galleryAssets =
  t("", { namespace: "gallery", locale: currentLang }) || {};
const aboutAssets = t("", { namespace: "aboutus", locale: currentLang }) || {};
const brandsAssets = t("", { namespace: "brands", locale: currentLang }) || {};
const newsAssets = t("", { namespace: "news", locale: currentLang }) || {};
const products =
  t("items", { namespace: "products", locale: currentLang }) || [];
const experiences =
  t("experiences", { namespace: "experiences", locale: currentLang }) || [];
const brandsList = brandsAssets.brands || [];
const zambosBrand = brandsList.find((brand: any) => brand.id === "zambos");
const zambosProducts = zambosBrand?.products || [];

const commonAssets =
  t("assets.slider", { namespace: "common", locale: currentLang }) || [];
const discoverAssets =
  t("home.socialmedia", { namespace: "common", locale: currentLang }) || {};

const slides = Array.isArray(commonAssets)
  ? commonAssets
      .filter(
        (asset) =>
          asset && typeof asset === "object" && asset.desktop && asset.mobile,
      )
      .map((asset) => ({
        desktop: asset.desktop,
        mobile: asset.mobile,
        alt: asset.alt || "Zambos",
        title: asset.title || "",
        subtitle: asset.description || "",
        link: asset.url || asset.link || "",
      }))
  : [];

// Load latest blog posts by current language from markdown
const blogModules = import.meta.glob("../../locales/*/blog/*.md");
let latestBlogPosts: Array<{
  id: string;
  slug: string;
  title: string;
  image?: string;
  published_date?: string;
}> = [];
for (const path in blogModules) {
  const lang = path.split("/")[3];
  if (lang === currentLang) {
    const mod: any = await blogModules[path]();
    const fm = mod.frontmatter || {};
    if (fm && fm.id && fm.slug && fm.title) {
      latestBlogPosts.push({
        id: String(fm.id),
        slug: String(fm.slug),
        title: String(fm.title),
        image: fm.image ? String(fm.image) : "/images/blog/placeholder.jpg",
        published_date: fm.published_date ? String(fm.published_date) : "",
      });
    }
  }
}
function toDate(s?: string) {
  if (!s) return 0;
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) {
    const [d, m, y] = s.split("/").map(Number);
    return new Date(y, (m || 1) - 1, d || 1).getTime();
  }
  const t = Date.parse(s);
  return isNaN(t) ? 0 : t;
}
latestBlogPosts = latestBlogPosts
  .sort((a, b) => toDate(b.published_date) - toDate(a.published_date))
  .slice(0, 5);
const noNewsText =
  currentLang === "es"
    ? "No se encuentra novedades aún para mostrar"
    : "There are no updates to show yet";
const topNewsLabel =
  currentLang === "es" ? "NOTICIAS MÁS IMPORTANTES" : "TOP NEWS";
const featuredLabel = currentLang === "es" ? "DESTACADOS" : "FEATURED";
---

<!-- src/views/Home/index.astro -->
<main class="w-full flex flex-col items-center justify-center mt-0">
  <!-- Slider Section con VideoCarousel -->
  <div class="relative w-full overflow-hidden">
    <VideoCarousel
      slides={slides}
      height="100vh"
      mobileHeight="300px"
      showOverlay={true}
    />
  </div>

  <!-- Sección de Productos Zibas -->
  {
    zambosProducts.length > 0 && (
      <section
        id="products"
        class="w-full py-4 bg-primary pt-16 relative overflow-hidden"
      >
        <div
          class="hidden lg:block absolute top-[-15%] left-1/2 -translate-x-1/2 w-[1238px] h-[1238px] rounded-full opacity-20 z-0 pointer-events-none"
          style="background: linear-gradient(270deg, #009337 0%, #006626 100%);"
        />

        <div
          class="hidden md:block lg:hidden xl:hidden absolute top-[-10%] left-1/2 -translate-x-1/2 w-[900px] h-[1100px] rounded-full opacity-20 z-0 pointer-events-none"
          style="background: linear-gradient(270deg, #009337 0%, #006626 100%);"
        />

        <div class="container mx-auto px-4 relative z-10">
          {brandsAssets.home?.title && (
            <div class="text-center mb-2 relative z-20">
              {brandsAssets.home?.subtitle && (
                <h1 class="lg:text-[84px] text-[64px] italic font-bold uppercase text-white">
                  {brandsAssets.home?.subtitle}
                </h1>
              )}
            </div>
          )}

          <ProductsCarousel
            products={products}
            color={"white"}
            autoplay={true}
            speed={4000}
            slidesPerView={3}
            spaceBetween={30}
            loop={true}
            className="max-w-7xl mx-auto mb-8"
          />
        </div>
      </section>
    )
  }

  <section class="w-full bg-yellow flex justify-center items-center py-8">
    <div class="container text-center">
       <h2  class='titles text-greenDark'>
        {
          currentLang === "es"
            ? "CONOCE MAS DE LAS EXPERIENCIAS ZAMBOS"
            : "LEARN MORE ABOUT ZAMBOS EXPERIENCES"
        }
      </h2>
    <ExperiencesCarousel experiences={experiences} />
    </div>
  </section>

  <!-- Sección instagram-->
  <section
    id="instagram"
    class="bg-green w-full py-12"
    transition:animate="slide"
  >
    <div class="container mx-auto px-4 text-center">
      <h2
        class="titles text-white"
      >
        {discoverAssets.title}
      </h2>
      <div class="container mx-auto px-4">
        <Discover
          title={discoverAssets.title}
          images={discoverAssets.images || []}
        />
      </div>
    </div>
  </section>

  <section class="w-full">
    <Subscription />
  </section>
</main>
