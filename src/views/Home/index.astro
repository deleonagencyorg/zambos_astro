---
import LazyImage from "../../components/common/LazyImage.astro";
// Component Imports
import VideoCarousel from "../../components/common/VideoCarousel/index.astro";
import RecipesCarousel from "../../components/recipes/RecipesCarousel.astro";
import ProductsCarousel from "../../components/common/ProductsCarousel/index.astro";
import MasonryGallery from "../../components/gallery/MasonryGallery.astro";
import PixelGrid from "../../components/atoms/PixelGrid.astro";
import BlogCard from "../../components/blog/BlogCard.astro";
import ExperiencesCarousel from "../../components/common/Experiences/index.astro";
import Subscription from "../../components/subscription/index.astro";
import Discover from "../../components/common/Discover/index.astro";
import VideosGrid from "../../components/common/VideosGrid.astro";

// Style Imports
import "./styles.css";

// i18n and Data Imports
import { t, getLocale } from "../../i18n/i18n";
import { InstagramEmbed } from "react-social-media-embed";

// Props
export interface Props {
  loading?: boolean;
}
const { loading = false } = Astro.props;

// Language and Data Setup
const currentLang = getLocale();
const homeAssets =
  t("home", { namespace: "common", locale: currentLang }) || {};
const recipesAssets =
  t("", { namespace: "recipes", locale: currentLang }) || {};
const galleryAssets =
  t("", { namespace: "gallery", locale: currentLang }) || {};
const aboutAssets = t("", { namespace: "aboutus", locale: currentLang }) || {};
const brandsAssets = t("", { namespace: "brands", locale: currentLang }) || {};
const newsAssets = t("", { namespace: "news", locale: currentLang }) || {};
const products =
  t("items", { namespace: "products", locale: currentLang }) || [];
const experiences =
  t("experiences", { namespace: "experiences", locale: currentLang }) || [];
const brandsList = brandsAssets.brands || [];
const zambosBrand = brandsList.find((brand: any) => brand.id === "zambos");
const zambosProducts = zambosBrand?.products || [];

const commonAssets =
  t("assets.slider", { namespace: "common", locale: currentLang }) || [];
const discoverAssets =
  t("home.socialmedia", { namespace: "common", locale: currentLang }) || {};

const videosAssets = t("videos", { namespace: "common", locale: currentLang }) || {};
const videoItems = Array.isArray(videosAssets.items) ? videosAssets.items : [];

// Social URLs (same sources as Footer)
const instagramUrl = t('social_media.instagram.url', { namespace: 'common', locale: currentLang });
const facebookUrl = t('social_media.facebook.url', { namespace: 'common', locale: currentLang });
const tiktokUrl = t('social_media.tiktok.url', { namespace: 'common', locale: currentLang });

const slides = Array.isArray(commonAssets)
  ? commonAssets
      .filter(
        (asset) =>
          asset && typeof asset === "object" && asset.desktop && asset.mobile,
      )
      .map((asset) => ({
        desktop: asset.desktop,
        mobile: asset.mobile,
        alt: asset.alt || "Zambos",
        title: asset.title || "",
        subtitle: asset.description || "",
        link: asset.url || asset.link || "",
      }))
  : [];

// Load latest blog posts by current language from markdown
const blogModules = import.meta.glob("../../locales/*/blog/*.md");
let latestBlogPosts: Array<{
  id: string;
  slug: string;
  title: string;
  image?: string;
  published_date?: string;
}> = [];
for (const path in blogModules) {
  const lang = path.split("/")[3];
  if (lang === currentLang) {
    const mod: any = await blogModules[path]();
    const fm = mod.frontmatter || {};
    if (fm && fm.id && fm.slug && fm.title) {
      latestBlogPosts.push({
        id: String(fm.id),
        slug: String(fm.slug),
        title: String(fm.title),
        image: fm.image ? String(fm.image) : "/images/blog/placeholder.jpg",
        published_date: fm.published_date ? String(fm.published_date) : "",
      });
    }
  }
}
function toDate(s?: string) {
  if (!s) return 0;
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) {
    const [d, m, y] = s.split("/").map(Number);
    return new Date(y, (m || 1) - 1, d || 1).getTime();
  }
  const t = Date.parse(s);
  return isNaN(t) ? 0 : t;
}
latestBlogPosts = latestBlogPosts
  .sort((a, b) => toDate(b.published_date) - toDate(a.published_date))
  .slice(0, 5);
const noNewsText =
  currentLang === "es"
    ? "No se encuentra novedades aún para mostrar"
    : "There are no updates to show yet";
const topNewsLabel =
  currentLang === "es" ? "NOTICIAS MÁS IMPORTANTES" : "TOP NEWS";
const featuredLabel = currentLang === "es" ? "DESTACADOS" : "FEATURED";
---

<!-- src/views/Home/index.astro -->
<main class="w-full flex flex-col items-center justify-center mt-0">
  <!-- Slider Section con VideoCarousel -->
  <div class="relative w-full overflow-hidden">
          <div
            id="social-links-carousel"
            class="absolute z-30 right-4 top-3/4 -translate-y-1/2 hidden lg:block"
          >
            <div class="flex flex-col gap-4 items-center">
              <a
                href={instagramUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="bg-[#FF0001] w-12 h-12 flex items-center justify-center rounded-full shadow-lg shadow-black/20 ring-2 ring-white/30 hover:opacity-90 transition"
              >
                <svg
                  width="30"
                  height="30"
                  viewBox="0 0 23 23"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M7.56281 11.3433C7.56281 9.25511 9.25511 7.5619 11.3433 7.5619C13.4315 7.5619 15.1247 9.25511 15.1247 11.3433C15.1247 13.4315 13.4315 15.1247 11.3433 15.1247C9.25511 15.1247 7.56281 13.4315 7.56281 11.3433ZM5.51865 11.3433C5.51865 14.5603 8.12634 17.168 11.3433 17.168C14.5603 17.168 17.168 14.5603 17.168 11.3433C17.168 8.12634 14.5603 5.51865 11.3433 5.51865C8.12634 5.51865 5.51865 8.12634 5.51865 11.3433ZM16.0374 5.2877C16.0373 5.55692 16.117 5.82012 16.2664 6.04404C16.4159 6.26794 16.6285 6.4425 16.8771 6.54562C17.1258 6.64874 17.3995 6.67582 17.6636 6.6234C17.9276 6.57098 18.1703 6.44143 18.3606 6.25115C18.5511 6.06085 18.6808 5.81836 18.7335 5.55434C18.7861 5.29031 18.7592 5.01661 18.6563 4.76784C18.5534 4.51908 18.379 4.30642 18.1552 4.15675C17.9315 4.0071 17.6683 3.92716 17.399 3.92705C17.0381 3.92722 16.6917 4.07061 16.4364 4.32573C16.1812 4.58084 16.0376 4.92684 16.0374 5.2877ZM6.76061 20.5765C5.65468 20.5262 5.05358 20.3419 4.65411 20.1863C4.12452 19.9801 3.74665 19.7345 3.34936 19.3378C2.95207 18.941 2.70615 18.5635 2.50088 18.0339C2.34516 17.6346 2.16094 17.0333 2.11067 15.9275C2.05568 14.7318 2.0447 14.3726 2.0447 11.3434C2.0447 8.31419 2.05659 7.95601 2.11067 6.75934C2.16104 5.65341 2.34661 5.0533 2.50088 4.65284C2.70706 4.12324 2.95262 3.74538 3.34936 3.34809C3.7461 2.9508 4.12361 2.70488 4.65411 2.49961C5.0534 2.34389 5.65468 2.15967 6.76061 2.1094C7.95628 2.05441 8.31546 2.04343 11.3433 2.04343C14.3712 2.04343 14.7306 2.05532 15.9274 2.1094C17.0333 2.15976 17.6334 2.34534 18.0338 2.49961C18.5634 2.70488 18.9413 2.95135 19.3386 3.34809C19.7359 3.74483 19.9809 4.12324 20.1871 4.65284C20.3428 5.05212 20.5271 5.65341 20.5773 6.75934C20.6323 7.95601 20.6432 8.31419 20.6432 11.3434C20.6432 14.3726 20.6323 14.7308 20.5773 15.9275C20.527 17.0333 20.3418 17.6345 20.1871 18.0339C19.9809 18.5635 19.7353 18.9414 19.3386 19.3378C18.9418 19.7342 18.5634 19.9801 18.0338 20.1863C17.6345 20.3419 17.0333 20.5262 15.9274 20.5765C14.7317 20.6314 14.3725 20.6424 11.3433 20.6424C8.3141 20.6424 7.95592 20.6314 6.76061 20.5765ZM6.66669 0.068695C5.45912 0.123687 4.63397 0.315162 3.91335 0.595569C3.16705 0.88514 2.53527 1.27363 1.90395 1.90395C1.27263 2.53427 0.88514 3.16705 0.595569 3.91335C0.315162 4.63442 0.123687 5.45912 0.068695 6.66668C0.0127952 7.87615 0 8.26282 0 11.3433C0 14.4238 0.0127952 14.8105 0.068695 16.0199C0.123687 17.2275 0.315162 18.0522 0.595569 18.7733C0.88514 19.5191 1.27272 20.1526 1.90395 20.7826C2.53518 21.4127 3.16705 21.8007 3.91335 22.0911C4.63533 22.3715 5.45912 22.563 6.66669 22.6179C7.87679 22.6729 8.26282 22.6866 11.3433 22.6866C14.4238 22.6866 14.8105 22.6738 16.0199 22.6179C17.2275 22.563 18.0522 22.3715 18.7733 22.0911C19.5191 21.8007 20.1514 21.413 20.7826 20.7826C21.414 20.1523 21.8007 19.5191 22.0911 18.7733C22.3715 18.0522 22.5639 17.2275 22.6179 16.0199C22.6729 14.8096 22.6857 14.4238 22.6857 11.3433C22.6857 8.26282 22.6729 7.87615 22.6179 6.66668C22.563 5.45903 22.3715 4.63397 22.0911 3.91335C21.8007 3.1675 21.413 2.53527 20.7826 1.90395C20.1523 1.27263 19.5191 0.88514 18.7742 0.595569C18.0522 0.315162 17.2275 0.12278 16.0208 0.068695C14.8114 0.0137027 14.4247 0 11.3442 0C8.26373 0 7.87679 0.0127952 6.66669 0.068695Z"
                    fill="white"
                  />
                </svg>
              </a>

              <a
                href={facebookUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="bg-[#FF0001] w-12 h-12 flex items-center justify-center rounded-full shadow-lg shadow-black/20 ring-2 ring-white/30 hover:opacity-90 transition"
              >
                <svg
                  width="30"
                  height="30"
                  viewBox="0 0 22 22"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M10.8896 0C16.9038 0 21.7791 4.87542 21.7791 10.8896C21.7791 16.3249 17.7969 20.8299 12.5911 21.6469V14.0374H15.1284L15.6112 10.8896L12.5911 10.8892V8.84684C12.5911 8.84009 12.5911 8.83344 12.5912 8.82669C12.5912 8.81657 12.5914 8.80655 12.5915 8.79642C12.6079 7.95323 13.0394 7.14628 14.3656 7.14628H15.7388V4.46642C15.7388 4.46642 14.4926 4.25331 13.3012 4.25331C10.8525 4.25331 9.23893 5.71426 9.18927 8.36345C9.18851 8.40538 9.18808 8.44752 9.18808 8.48999V10.8892H6.42315V14.0369L9.18808 14.0374V21.6464C3.98216 20.8295 0 16.3249 0 10.8896C0 4.87542 4.87542 0 10.8896 0Z"
                    fill="white"
                  />
                </svg>
              </a>

              <a
                href={tiktokUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="bg-[#FF0001] w-12 h-12 flex items-center justify-center rounded-full shadow-lg shadow-black/20 ring-2 ring-white/30 hover:opacity-90 transition"
              >
                <svg
                  width="30"
                  height="30"
                  viewBox="0 0 20 23"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M10.3514 0.0189093C11.5898 -1.26771e-08 12.8186 0.00944897 14.0474 0C14.1231 1.44625 14.643 2.92087 15.7017 3.94175C16.7604 4.991 18.2539 5.47307 19.7096 5.63376V9.44318C18.3484 9.39588 16.9777 9.1123 15.7395 8.52626C15.2007 8.28051 14.6997 7.96857 14.2082 7.64717C14.1988 10.4074 14.2176 13.1675 14.1892 15.9183C14.1137 17.2416 13.6788 18.5555 12.9131 19.6425C11.6749 21.4574 9.52905 22.6391 7.32664 22.6768C5.97492 22.7525 4.62318 22.3839 3.46996 21.7033C1.56053 20.5783 0.218268 18.5177 0.0197608 16.3058C0.000851472 15.8332 -0.00859763 15.3605 0.0103003 14.8974C0.18045 13.1014 1.069 11.381 2.44909 10.2089C4.01823 8.84766 6.21122 8.19543 8.26246 8.58298C8.28129 9.98199 8.22457 11.381 8.22457 12.7799C7.28882 12.4775 6.19232 12.5626 5.36994 13.1298C4.77443 13.5172 4.32071 14.1128 4.08437 14.784C3.88587 15.266 3.94259 15.7953 3.95205 16.3058C4.17892 17.8561 5.67242 19.1604 7.26046 19.0187C8.31918 19.0092 9.33055 18.3949 9.87888 17.4968C10.0584 17.1849 10.257 16.8635 10.2664 16.4949C10.361 14.8028 10.3231 13.1202 10.3326 11.4283C10.342 7.61881 10.3231 3.81885 10.3514 0.0189093Z"
                    fill="white"
                  />
                </svg>
              </a>
            </div>
          </div>
    <VideoCarousel
      slides={slides}
      height="650px"
      mobileHeight="300px"
      showOverlay={true}
    />
  </div>


  {
    zambosProducts.length > 0 && (
      <section
        id="products"
        class="w-full py-4 bg-primary pt-16 relative overflow-hidden"
      >
        <div
          class="hidden lg:block absolute top-[-15%] left-1/2 -translate-x-1/2 w-[1238px] h-[1238px] rounded-full opacity-20 z-0 pointer-events-none"
          style="background: linear-gradient(270deg, #009337 0%, #006626 100%);"
        />

        <div
          class="hidden md:block lg:hidden xl:hidden absolute top-[-10%] left-1/2 -translate-x-1/2 w-[900px] h-[1100px] rounded-full opacity-20 z-0 pointer-events-none"
          style="background: linear-gradient(270deg, #009337 0%, #006626 100%);"
        />

        <div class="container mx-auto px-4 relative z-10">
          {brandsAssets.home?.title && (
            <div class="text-center mb-2 relative z-20">
              {brandsAssets.home?.subtitle && (
                <h1 class="lg:text-[84px] text-[40px] italic font-bold uppercase text-white">
                  {brandsAssets.home?.subtitle}
                </h1>
              )}
            </div>
          )}

          <ProductsCarousel
            products={products}
            autoplay={true}
            speed={4000}
            loop={true}
            className="max-w-7xl mx-auto mb-8"
          />
        </div>
      </section>
    )
  }

  <section class="w-full bg-yellow flex justify-center items-center py-8">
    <div class="container text-center">
       <h2  class='titles text-greenDark'>
        {
          currentLang === "es"
            ? "Conoce más DE LAS EXPERIENCIAS ZAMBOS"
            : "LEARN MORE ABOUT ZAMBOS EXPERIENCES"
        }
      </h2>
    <ExperiencesCarousel experiences={experiences} />
    </div>
  </section>

  <!-- Sección instagram-->
  <section
    id="instagram"
    class="bg-green w-full py-12"
    transition:animate="slide"
  >
    <div class="container mx-auto px-4">
      <div class="max-w-6xl mx-auto text-center flex flex-col items-center">
        <h2 class="titles text-white mb-8">
          {discoverAssets.title}
        </h2>
        <div class="w-full">
          <Discover
            title={discoverAssets.title}
            images={discoverAssets.images || []}
          />
        </div>
      </div>
    </div>
  </section>
  <section class="w-full bg-green py-16">
    <div class="container mx-auto px-4 md:px-4 lg:px-16">
      <h2 class="titles text-white text-center mb-10">NUESTROS VIDEOS</h2>
      <VideosGrid items={videoItems} />
    </div>
  </section>
  <section class="w-full bg-green">
    <Subscription />
  </section>
