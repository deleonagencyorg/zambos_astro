---
// src/views/Blog/index.astro
import { getLocale, t} from '../../i18n/i18n';
import { ViewTransitions } from 'astro:transitions';
import MainLayout from '../../layouts/MainLayout.astro';
import './styles.css';
import BlogCard from '../../components/blog/BlogCard.astro';
import Breadcrumb from '../../components/common/Breadcrumb/Breadcrumb.astro';
import NewsCarousel from '../../components/blog/NewsCarousel.astro';

interface Recipe {
  id: string;
  title: string;
  image?: string;
  slug?: string;
  preparation_time: number;
  type?: string;
}

const currentLang = getLocale();
const recipeModules = import.meta.glob<{default: Recipe}>('../../locales/*/recipes/*.json');
const allRecipes: Recipe[] = [];

for (const path in recipeModules) {
  const lang = path.split('/')[3]; // Extract language from path
  if (lang === currentLang) {
    const module = await recipeModules[path]();
    allRecipes.push(module.default);
  }
}

function normalizeType(r: Recipe): string {
  const rawCategory = String((r as any).category || '').toLowerCase().trim();
  const rawType = String((r as any).type || '').toLowerCase().trim();

  const raw = rawCategory || rawType;

  if (['breakfast', 'desayuno'].includes(raw)) return 'breakfast';
  if (['brunch'].includes(raw)) return 'brunch';
  if (['lunch', 'almuerzo'].includes(raw)) return 'lunch';
  return 'other';
}

const filterLabels = currentLang === 'es'
  ? { 
      oldest: 'MÁS ANTIGUAS',
      newest: 'MAS RECENTES', 
      all: 'VER TODOS',
    }
  : {
      oldest: 'OLDEST',
      newest: 'NEWEST',
      all: 'ALL'
    };

const pageTitle = currentLang === 'es' ? 'Noticias' : 'News';
const pageDescription = currentLang === 'es' 
  ? 'Mantente al día con nuestras últimas noticias y artículos.' 
  : 'Stay updated with our latest news and articles.';

// Load markdown posts for the current language
const mdModules = import.meta.glob('../../locales/*/blog/*.md');
// Build dynamic categories set

const posts = t('posts', { namespace: 'blog', locale: currentLang });

const noPostsText = currentLang === 'es'
  ? 'No hay noticias disponibles en este momento.'
  : 'No blog posts available at this time.';

// Labels and splits for the two-column layout below
const topNewsLabel = currentLang === 'es' ? 'NOTICIAS MÁS IMPORTANTES' : 'TOP NEWS';
const featuredLabel = currentLang === 'es' ? 'DESTACADOS' : 'FEATURED';
---
<MainLayout title={pageTitle} description={pageDescription} class="bg-[#0DB04A]">
  <ViewTransitions />
  <div class="-mt-px -mb-px overflow-hidden pb-15" >
    <div class="container mx-auto px-4 mt-0 pb-16">
      <div class="pt-4">
        <Breadcrumb bgColor="bg-transparent" textColor="text-white" hoverColor="hover:text-white" />
      </div>
      <!-- News Carousel listing 4 per slide -->
      <div class="max-w-6xl mx-auto mb-16">
        <NewsCarousel />
      </div>

      <div class="flex flex-col md:flex-row gap-4 mb-8">
        <!-- Search Bar -->
        <div class="flex-1">
          <div class="relative">
            <input
              type="text"
              id="recipeSearch"
              placeholder={currentLang === 'es' ? 'Buscar producto...' : 'Search product...'}
              class="w-full px-12 py-4 rounded-full text-gray-700 focus:outline-none focus:ring-2 focus:ring-white"
            />
            <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
        </div>

        <!-- Category Filters -->
        <div id="recipeFilters" class="flex flex-wrap gap-3">
          <button 
            type="button" 
            class="filter-btn px-8 py-4 rounded-full bg-red text-white font-bold transition-all whitespace-nowrap" 
            data-filter="all"
          >
            {filterLabels.oldest}
          </button>
          <button 
            type="button" 
            class="filter-btn px-8 py-4 rounded-full bg-white text-gray-700 font-bold transition-all whitespace-nowrap" 
            data-filter="newest"
          >
            {filterLabels.newest}
          </button>
          <button 
            type="button" 
            class="filter-btn px-8 py-4 rounded-full bg-white text-gray-700 font-bold transition-all whitespace-nowrap" 
            data-filter="brunch"
          >
            {filterLabels.all}
          </button>
        </div>
      </div>


      <div id="recipesGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 lg:gap-8">
        {posts.map((recipe: Recipe) => (
          <div class="recipe-card" data-type={normalizeType(recipe)}>
            <BlogCard
              image={recipe.image || '/images/recipes/placeholder.jpg'}
              title={recipe.title}
              id={recipe.id}
              slug={recipe.slug}
              category={normalizeType(recipe).toUpperCase()}
              isNew={(recipe as any).isNew || false}
            />
          </div>
        ))}
      </div>
    </div>
  </div>
</MainLayout>

<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script define:vars={{ initialPosts: currentLang }}>
  function initBlogFilters(){
    const filterButtons = Array.from(document.querySelectorAll('#blogFilters .filter-btn'));
    const data = Array.isArray(initialPosts) ? initialPosts : [];

    function getCarousel(){ return (window)._newsCarousels && (window)._newsCarousels['news-list']; }

    function setActive(btn) {
      filterButtons.forEach(b => { b.classList.remove('opacity-40'); b.classList.add('text-white'); });
      filterButtons.forEach(b => { if (b!==btn) b.classList.add('opacity-40'); });
    }
    function applyFilter(filter) {
      const carousel = getCarousel();
      if (!carousel) return; // will be re-applied on ready
      const filtered = filter === 'all' 
        ? data 
        : data.filter(p => (p.category || 'other').toLowerCase() === filter);
      carousel.setData(filtered);
    }
    filterButtons.forEach((btn) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const filter = btn.getAttribute('data-filter') || 'all';
        setActive(btn);
        applyFilter(filter);
      });
    });
    // init
    const defaultBtn = filterButtons.find(b => b.getAttribute('data-filter') === 'all');
    if (defaultBtn) setActive(defaultBtn);

    // Ensure carousel receives initial data when ready
    const applyInitial = () => {
      const c = getCarousel();
      if (c) { 
        c.setData(data); 
        // Also apply the "all" filter to show all posts initially
        const defaultBtn = filterButtons.find(b => b.getAttribute('data-filter') === 'all');
        if (defaultBtn) setActive(defaultBtn);
        return true; 
      }
      return false;
    };
    
    // Try immediate application
    if (!applyInitial()) {
      // If carousel not ready, retry with polling
      const start = Date.now();
      const timer = setInterval(() => {
        if (applyInitial() || Date.now() - start > 3000) clearInterval(timer);
      }, 100);
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBlogFilters);
  } else {
    initBlogFilters();
  }
  document.addEventListener('astro:page-load', initBlogFilters);
</script>
