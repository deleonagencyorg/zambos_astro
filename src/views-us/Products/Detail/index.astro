---
// src/views/Products/Detail/index.astro
import { t } from '../../../i18n/i18n';
import type { Locale } from '../../../i18n/i18n';
import './styles.css';
import { initProductDetail } from './scripts.js';
import ProductsCarousel from '../../../components/common/ProductsCarousel/index.astro';
import LazyImage from '../../../components/common/LazyImage.astro';
import Subscription from '../../../components/subscription/index.astro';
import ExperiencesCarousel from '../../../components/common/Experiences/index.astro';
import RecipesCarousel from '../../../components/recipes/RecipesCarousel.astro';

// Interfaces locales
interface ProductSize {
  value: string;
  image: string;
}

interface Recipe {
  id: string;
  title: string;
  image?: string;
  preparation_time: number;
  type?: string;
  category?: string;
  isNew?: boolean;
  description?: string;
}

interface Stockist {
  id: string;
  name: string;
  icon: string;
  link: string;
}

interface Product {
  id: string;
  name: string;
  image: string;
  available?: string;
  background_image: string;
  background_color: string;
  header_text_color: string;
  color_button: string;
  sizes: ProductSize[];
  description?: string;
  short_description?: string;
  nutrition?: any;
  presentaciones?: Array<{
    value: string;
    icono: string;
  }>;
  // relatedProducts es opcional ya que no existe en la estructura actual
  relatedProducts?: string[];
  weight?: string[];
}

const { currentLang, productId } = Astro.props;

// Obtener datos desde traducciones
const productsAssets = t('home', { namespace: 'products', locale: currentLang }) || {};
const products = t('items', { namespace: 'products', locale: currentLang as Locale }) || [];
const stockists = t('stockist', { namespace: 'products', locale: currentLang as Locale }) || [];
const product = products.find((item: Product) => item.id === productId);
const brandsAssets = t('', { namespace: 'brands', locale: currentLang }) || {};
const newsAssets =  t('', { namespace: 'news', locale: currentLang }) || {};
const brandsList = brandsAssets.brands || [];
const zambosBrand = brandsList.find((brand: any) => brand.id === 'Zambos');
const zambosProducts = (zambosBrand?.products || []).filter((product: any) => product.id !== productId);
const experiences = t('experiences', { namespace: 'experiences', locale: currentLang }) || [];

// Recetas (mismo origen que src/views/Recipes)
const recipeModules = import.meta.glob<{ default: Recipe }>("../../../locales/*/recipes/*.json");
const recommendedRecipes: Recipe[] = [];
for (const path in recipeModules) {
  const parts = path.split('/');
  const localesIdx = parts.lastIndexOf('locales');
  const lang = localesIdx >= 0 ? parts[localesIdx + 1] : '';
  if (lang === currentLang) {
    const mod = await recipeModules[path]();
    recommendedRecipes.push(mod.default);
  }
}

// Limitar cantidad para el carrusel
const recommendedRecipesSlice = recommendedRecipes
  .filter((r) => r && typeof r.id === 'string')
  .slice(0, 8);

// Si el producto no existe, lanzar error
if (!product || Object.keys(product).length === 0) {
  throw new Error(t('errors.product_not_found', { locale: currentLang }));
}

// Asegurar que todas las propiedades necesarias existan
const safeProduct: Product = {
  id: product.id || '',
  name: product.name || '',
  image: product.image || '',
  background_image: product.background_color || '',
  background_color: product.background_color || '',
  header_text_color: product.header_text_color || '#000000',
  color_button: product.color_button || '#000000',
  sizes: Array.isArray(product.sizes) ? product.sizes : [],
  available: product.available || '',
  description: product.description || '',
  nutrition: (product as any).nutrition,
  weight: Array.isArray(product.weight) ? product.weight : [],
  
};

function hasNutrition(nutrition: any): boolean {
  if (nutrition === undefined || nutrition === null) return false;
  if (typeof nutrition === 'string') return nutrition.trim().length > 0;
  if (Array.isArray(nutrition)) return nutrition.length > 0;
  if (typeof nutrition === 'object') return Object.keys(nutrition).length > 0;
  return false;
}

const nutritionData = safeProduct.nutrition;
const nutritionIsString = typeof nutritionData === 'string';
const nutritionIsArray = Array.isArray(nutritionData);
const nutritionIsObject =
  !!nutritionData && typeof nutritionData === 'object' && !Array.isArray(nutritionData);
const nutritionEntries = nutritionIsObject ? Object.entries(nutritionData) : [];

// Obtener todos los productos como un array
const productsData = t('items', { locale: currentLang, namespace: 'products' }) || [];
const allProductsArray = Array.isArray(productsData) ? productsData : [];

// Filtrar productos relacionados - simplificado para evitar errores
let relatedProducts: any[] = [];
// Solo usar productos de la misma categoría si hay más de 1 producto
if (allProductsArray.length > 1) {
  relatedProducts = allProductsArray
    .filter((p: any) => p.id !== productId)
    .slice(0, 3);
}

---

{safeProduct.background_color && (
  <article
    id="product-detail"
    class="product-detail min-h-screen h-full relative overflow-hidden bg-cover bg-center bg-no-repeat py-12" style="background-image: url('https://snack.yummiespromociones.com/SnacksyummiesAssets/bgproductdetailus.webp'); "
    transition:animate="slide"
  >
    <div class="container mx-auto px-6 md:px-12 py-8 md:py-16">
      <!-- Enlace "Ir a Productos" -->
      <a 
        href={`/${currentLang}/products`} 
        class="inline-flex items-center text-sm md:text-base font-medium mb-6 hover:opacity-80 transition-opacity"
        style={{ color: '#FFF' }}
      >
        {currentLang === 'es' ? 'Ir a Productos' : 'Go to Products'}
      </a>

      <div class="flex flex-col lg:flex-row items-center lg:items-start gap-8 lg:gap-16">
        <!-- Contenido del lado izquierdo -->
        <div class="w-full lg:w-1/2 order-2 lg:order-1">
          <!-- Título del producto -->
          <h1 
            class="text-4xl md:text-5xl lg:text-6xl font-bold italic leading-tight mb-8"
            style={{ color: '#FFF' }}
          >
            {safeProduct.name}
          </h1>



          <!-- Botones de peso/presentaciones -->
          {safeProduct.weight && safeProduct.weight.length > 0 && (
            <div class="flex flex-wrap gap-3 mb-10">
              {safeProduct.weight.map((weight) => (
                <button 
                  class="px-10 py-4 rounded-md text-us-green  bg-white font-semibold text-sm md:text-base hover:opacity-90 transition-opacity"
                
                >
                  {weight}
                </button>
              ))}
            </div>
          )}

          <!-- Sección Descripción (Acordeón) -->
          <div class="border-t py-4" style={{ borderColor: `${safeProduct.header_text_color}40` }}>
            <button 
              class="accordion-trigger w-full flex justify-between items-center text-left"
              data-accordion="description"
              style={{ color: '#FFF' }}
            >
              <span class="text-2xl sm:text-3xl md:text-4xl font-semibold text-us-red">
                {currentLang === 'es' ? 'Descripción' : 'Description'}
              </span>
              <span class="accordion-icon text-4xl font-light transition-transform duration-300">−</span>
            </button>
            <div class="accordion-content overflow-hidden transition-all duration-300 max-h-96" data-content="description">
              <p 
                class="pt-4 text-base md:text-lg leading-relaxed md:text-white text-us-green"
                
              >
                {safeProduct.description}
              </p>
            </div>
          </div>

          <!-- Sección Datos Nutricionales (Acordeón) -->
          {hasNutrition(safeProduct.nutrition) && (
            <div class="border-t border-b py-4" style={{ borderColor: `${safeProduct.header_text_color}40` }}>
              <button 
                class="accordion-trigger w-full flex justify-between items-center text-left"
                data-accordion="nutrition"
              >
                <span class="text-2xl sm:text-3xl md:text-4xl font-semibold text-us-green md:text-white">
                  {currentLang === 'es' ? 'Datos nutricionales' : 'Nutritional information'}
                </span>
                <span class="accordion-icon text-4xl font-light transition-transform duration-300 text-us-green md:text-white">+</span>
              </button>
              <div class="accordion-content overflow-hidden transition-all duration-300 max-h-0" data-content="nutrition">
                <div 
                  class="pt-4 text-base md:text-lg leading-relaxed text-us-green md:text-white"
                >
                  {nutritionIsString && <p>{nutritionData}</p>}

                  {nutritionIsArray && (
                    <div class="space-y-2">
                      {(nutritionData as any[]).map((row: any) => (
                        <p>{typeof row === 'string' ? row : JSON.stringify(row)}</p>
                      ))}
                    </div>
                  )}

                  {nutritionEntries.length > 0 && (
                    <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                      {nutritionEntries.map(([key, value]) => (
                        <div>
                          <dt class="font-semibold">{key}</dt>
                          <dd class="opacity-90">{String(value)}</dd>
                        </div>
                      ))}
                    </dl>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>

        <!-- Imagen del producto (lado derecho) -->
        <div class="w-full lg:w-1/2 order-1 lg:order-2 flex flex-col justify-center items-center">
          <img src="https://snack.yummiespromociones.com/SnacksyummiesAssets/vibesus.webp" alt="" class="h-[150px] object-contain mb-4">
          <div class="relative">
            <img 
              id="product-image" 
              class="max-w-full h-auto w-[300px] md:w-[400px] lg:w-[400px] object-contain drop-shadow-2xl transition-transform duration-500 hover:scale-105" 
              src={safeProduct.image} 
              alt={safeProduct.name} 
              transition:name={`product-image-${safeProduct.id}`} 
            />
          </div>
        </div>
      </div>
    </div>

    <section id="product-detail-experiences" data-country-target class="hidden">
      <ExperiencesCarousel 
        experiences={experiences}
        mainTitleColor='#FFF'
        backgroundColor='#FF0001'
        textColor='#FFF'
        buttonColor='#FFF'
        textButtonColor='#FF0001'
      />
    </section>


  </article>
    <section class="flex justify-center items-center">
    <a
      href={t('delivery.amazon_buy_url', { namespace: 'common', locale: currentLang })}
      target="_blank"
      rel="noopener noreferrer"
    >
      <img src="https://snack.yummiespromociones.com/SnacksyummiesAssets/bannerproductdetailus.webp" alt="Amazon Delivery" class=" h-auto w-[90%] md:w-[400px] lg:w-[1000px]" />
    </a>
  </section>
)}

<script>
  import { initProductDetail } from './scripts.js';

  function initProductDetailPage() {
    const root = document.getElementById('product-detail');
    if (!root) return;

    if (root.dataset.productDetailInitialized === 'true') return;
    root.dataset.productDetailInitialized = 'true';

    initProductDetail();

    const descriptionTrigger = root.querySelector('[data-accordion="description"]');
    const descriptionContent = root.querySelector('[data-content="description"]');
    const descriptionIcon = descriptionTrigger?.querySelector('.accordion-icon');
    if (descriptionContent && descriptionIcon) {
      descriptionContent.classList.remove('max-h-0');
      descriptionContent.classList.add('max-h-96');
      descriptionIcon.textContent = '−';
      descriptionIcon.classList.remove('rotate-45');
    }

    const accordionTriggers = root.querySelectorAll('.accordion-trigger');
    accordionTriggers.forEach((trigger) => {
      trigger.addEventListener('click', () => {
        const accordionId = trigger.getAttribute('data-accordion');
        if (!accordionId) return;
        const content = root.querySelector(`[data-content="${accordionId}"]`);
        const icon = trigger.querySelector('.accordion-icon');

        if (content && icon) {
          const isOpen = content.classList.contains('max-h-96');
          if (isOpen) {
            content.classList.remove('max-h-96');
            content.classList.add('max-h-0');
            icon.textContent = '+';
            icon.classList.remove('rotate-45');
          } else {
            content.classList.remove('max-h-0');
            content.classList.add('max-h-96');
            icon.textContent = '−';
            icon.classList.remove('rotate-45');
          }
        }
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProductDetailPage);
  } else {
    initProductDetailPage();
  }

  document.addEventListener('astro:page-load', initProductDetailPage);
  document.addEventListener('astro:after-swap', initProductDetailPage);
</script>

<script type="module">
  async function applyCountryBlocks() {
    const experiences = document.getElementById('product-detail-experiences');
    const recipes = document.getElementById('product-detail-recipes');

    if (!experiences || !recipes) return;

    try {
      const response = await fetch('/api/geo-headers', { cache: 'no-store' });
      const geo = response.ok ? await response.json() : null;
      const isHonduras = geo?.country === 'HN';

      experiences.classList.toggle('hidden', !isHonduras);
      recipes.classList.toggle('hidden', isHonduras);
    } catch (e) {
      experiences.classList.add('hidden');
      recipes.classList.remove('hidden');
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', applyCountryBlocks);
  } else {
    applyCountryBlocks();
  }
  document.addEventListener('astro:page-load', applyCountryBlocks);
  document.addEventListener('astro:after-swap', applyCountryBlocks);
</script>

<style>
  .accordion-content {
    transition: max-height 0.3s ease-out;
  }
  
  .accordion-icon {
    transition: transform 0.3s ease;
  }
  
  .rotate-45 {
    transform: rotate(45deg);
  }
</style>