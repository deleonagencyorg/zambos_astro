---
// src/components/contact/FormContact.astro
import { getLocale } from '../../i18n/i18n';
import type { Locale } from '../../i18n/i18n';
import SuccessModal from '../common/SuccessModal.astro';

// Import locale files statically
import contactEs from '../../locales/es/contact.json';
import contactEn from '../../locales/en/contact.json';

interface Props {
  currentLang?: Locale;
  formType?: string;
  hideContactReason?: boolean;
}

const { currentLang, formType = 'default', hideContactReason = false } = Astro.props;

// Get current locale if not provided
const locale = currentLang || getLocale();

// Get contact data from locale
const contact = locale === 'es' ? contactEs : contactEn;

// Get localized labels for fields not in contact.json
const countryLabel = locale === 'es' ? 'País' : 'Country';
const departmentLabel = locale === 'es' ? 'Departamento/Estado' : 'Department/State';
const cityLabel = locale === 'es' ? 'Ciudad' : 'City';
const countryPlaceholder = locale === 'es' ? 'Selecciona tu país' : 'Select your country';
const departmentPlaceholder = locale === 'es' ? 'Primero selecciona un país' : 'First select a country';
const contactReasonPlaceholder = locale === 'es' ? 'Selecciona el tipo de consulta' : 'Select the type of inquiry';

// Get API configuration from environment variables
const apiHost = import.meta.env.PUBLIC_CONTACT_API_HOST || 'https://api-crm.yummiespromociones.com/api';
const apiToken = import.meta.env.PUBLIC_CONTACT_API_TOKEN || '';
const contactFormPath = import.meta.env.PUBLIC_CONTACT_FORM_PATH || '/api/v1/auth/email/custom';

// Dynamic field labels based on language
const dynamicLabels = {
  es: {
    clientCode: 'Código de Cliente',
    areaOfInterest: 'Área de Interés',
    message: 'Mensaje',
    requestType: 'Tipo de Solicitud',
    interest: 'Interés',
    question: 'Pregunta o Solicitud',
    comments: 'Comentarios',
    file: 'Adjuntar Archivo',
    fileHelp: 'PDF, JPG, PNG (máx. 10MB)',
    areaOfInterestSupplier: 'Área de Interés',
    commentsEthics: 'Escribe tus comentarios. Si eres empleado Dinant especifica tu cargo'
  },
  en: {
    clientCode: 'Client Code',
    areaOfInterest: 'Area of Interest',
    message: 'Message',
    requestType: 'Request Type',
    interest: 'Interest',
    question: 'Question or Request',
    comments: 'Comments',
    file: 'Attach File',
    fileHelp: 'PDF, JPG, PNG (max. 10MB)',
    areaOfInterestSupplier: 'Area of Interest',
    commentsEthics: 'Write your comments. If you are a Dinant employee specify your position'
  }
};

const labels = dynamicLabels[locale];

// Dynamic options based on language
const dynamicOptions = {
  es: {
    clientAreaOfInterest: ['Sugerencias', 'Consultas', 'Reclamo'],
    requestTypes: ['Para consumo propio', 'Pulpería', 'Mini Mercado', 'Abastecedor', 'Otros'],
    exportInterests: ['Quiero ser distribuidor', 'Deseo producto para consumo personal'],
    journalistAreas: ['Presidencia Ejecutiva', 'Mercadeo', 'Relaciones Corporativas'],
    contactReason: ['Soy cliente', 'Quiero ser cliente', 'Exportaciones', 'Quiero ser proveedor', 'Enviar Hoja de vida', 'Soy Estudiante Universitario', 'Soy Periodista/ Medio de comunicación', 'Línea Ética YUMMIES', 'Soy un ganador', 'Otros']
  },
  en: {
    clientAreaOfInterest: ['Suggestions', 'Inquiries', 'Complaint'],
    requestTypes: ['For personal consumption', 'Small store', 'Mini Market', 'Supplier', 'Others'],
    exportInterests: ['I want to be a distributor', 'I want product for personal consumption'],
    journalistAreas: ['Executive Presidency', 'Marketing', 'Corporate Relations'],
    contactReason: ['I am a client', 'I want to be a client', 'Exports', 'I want to be a supplier', 'Send Resume', 'I am a University Student', 'I am a Journalist/Media', 'YUMMIES Ethics Line', '', 'Others']
  }
};

const options = dynamicOptions[locale];

---

<style>
  /* Estilo para las flechas de los selectores - hacerlas blancas */
  select {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1em;
    padding-right: 2.5rem !important;
  }
  
  /* Cambiar el color de la flecha cuando el select está en focus */
  select:focus {
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  }
</style>

<div
  id="contactFormContainer"
  class="bg-[#FFED7A] rounded-[40px] p-8"
  transition:name="contact-form"
  data-locale={locale}
  data-form-type={formType}
  data-hide-contact-reason={hideContactReason ? 'true' : 'false'}
  data-api-host={apiHost}
  data-api-token={apiToken}
  data-contact-form-path={contactFormPath}
  data-department-placeholder={departmentPlaceholder}
  data-country-placeholder={countryPlaceholder}
  data-labels={JSON.stringify(labels)}
  data-options={JSON.stringify(options)}
>
  <h2 class="text-[#009337] text-center md:text-2xl uppercase font-sans text-2xl font-bold mb-6">
    {contact.form.title}
  </h2>

  <form class="space-y-6 shadow-md" id="contactForm">
  <!-- Fila para Contact Reason y Country -->
  <div class="flex flex-col md:flex-row gap-6">
    <!-- Contact Reason Dropdown -->
    <div class="flex-1">
      {hideContactReason ? (
        <input type="hidden" name="contactReason" value={formType} />
      ) : (
        <>
          <label class="block text-[#009337] uppercase font-semibold  mb-2">
            {contact.form.contactReason.label} *
          </label>
          <select 
            name="contactReason" 
            id="contactReasonSelect"
            required
            class="w-full font-semibold uppercase flex justify-center text-[#009337] items-center gap-5 p-[15px_20px] border-[1.5px] border-white rounded-full bg-[#FFED7A] border-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
          >
            <option value="">{contactReasonPlaceholder}</option>
            {locale === 'es' ? (
              // En español, mostrar todas las opciones incluido "Soy un ganador"
              dynamicOptions.es.contactReason.map((reason) => (
                <option value={reason}>{reason}</option>
              ))
            ) : (
              // En inglés, mostrar solo las opciones que tienen texto (filtrar vacías)
              dynamicOptions.en.contactReason.map((reason, index) => {
                if (reason) { // Solo mostrar si tiene texto
                  return <option value={dynamicOptions.es.contactReason[index]}>{reason}</option>;
                }
                return null;
              })
            )}
          </select>
        </>
      )}
    </div>

    <!-- Country Selector -->
    {hideContactReason && formType === 'zambostruck' ? (
      <>
        <div class="flex-1">
          <select 
            name="country" 
            id="countrySelect"
            required
            class="hidden"
          >
            <option value="">{countryPlaceholder}</option>
          </select>
        </div>
        <div class="flex-1">
          <input type="hidden" name="contactReason" value={formType} />
        </div>
      </>
    ) : (
      <div class="flex-1">
        <label class="block text-[#009337] uppercase font-semibold  mb-2">
          {countryLabel} *
        </label>
        <select 
          name="country" 
          id="countrySelect"
          required
          class="w-full font-semibold uppercase flex justify-center text-[#009337] items-center gap-5 p-[15px_20px] border-[1.5px] border-white rounded-full  bg-[#FFED7A] border-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
        >
          <option value="">{countryPlaceholder}</option>
        </select>
      </div>
    )}
  </div>

  <!-- Fila para City y Name -->
  <div class="flex flex-col md:flex-row gap-6">
    <!-- City Selector -->
    <div class="flex-1">
      <label class="block text-[#009337] uppercase font-semibold  mb-2">
        {cityLabel} *
      </label>
      <select 
        name="city" 
        id="departmentSelect"
        required
        disabled
        class="w-full font-semibold uppercase flex justify-center text-[#009337] items-center gap-5 p-[15px_20px] border-[1.5px] border-white rounded-full  bg-[#FFED7A] border-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
      >
        <option value="">{departmentPlaceholder}</option>
      </select>
    </div>
    
    <!-- Name -->
    <div class="flex-1">
      <label class="block text-[#009337] uppercase font-semibold  mb-2">
        {contact.form.fullName.label} *
      </label>
      <input 
        type="text" 
        name="name" 
        required
        placeholder={contact.form.fullName.placeholder}
        class="w-full font-semibold uppercase placeholder:text-[#009337] flex justify-center text-[#009337] items-center gap-5 p-[15px_20px] border-[1.5px] border-white rounded-full  bg-[#FFED7A] border-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
      />
    </div>
  </div>
  
  <!-- Fila para Email y Phone -->
  <div class="flex flex-col md:flex-row gap-6">
    <!-- Email -->
    <div class="flex-1">
      <label class="block text-[#009337] uppercase font-semibold  mb-2">
        {contact.form.email.label} *
      </label>
      <input 
        type="email" 
        name="email" 
        required
        placeholder={contact.form.email.placeholder}
        class="w-full px-4 py-3 placeholder:text-[#009337]  bg-[#FFED7A] border-[#009337] text-[#009337] uppercase border-[1.5px] border-white rounded-full focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
      />
    </div>
    
    <!-- Phone -->
    <div class="flex-1">
      <label class="block text-[#009337] uppercase font-semibold  mb-2">
        {contact.form.phone.label}
      </label>
      <input 
        type="number" 
        name="phone" 
        placeholder={contact.form.phone.placeholder}
        class="w-full px-4 py-3 border-[1.5px] border-white rounded-full placeholder:text-[#009337]  bg-[#FFED7A] border-[#009337] text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
      />
    </div>
  </div>

  <!-- Fila para comentario -->
  {hideContactReason && formType === 'zambostruck' ? null : (
    <div class="flex flex-col md:flex-row gap-6">
      <div class="flex-1">
        <label class="block text-[#009337] uppercase font-semibold  mb-2">
          {contact.form.message.label} *
        </label>
        <textarea 
          name="message" 
          required
          rows="4"
          placeholder={contact.form.message.placeholder}
          class="w-full px-4 py-3 border-[1.5px] border-white rounded-2xl  bg-[#FFED7A] border-[#009337] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"
        ></textarea>
      </div>
    </div>
  )}

  <!-- Dynamic Fields Container -->
  <div id="dynamicFields" class="space-y-6">
    <!-- Dynamic fields will be inserted here -->
  </div>

  {hideContactReason && formType === 'zambostruck' ? (
    <div class="flex flex-col md:flex-row gap-6">
      <div class="flex-1">
        <label class="block text-[#009337] uppercase font-semibold  mb-2">
          {contact.form.message.label} *
        </label>
        <textarea 
          name="message" 
          required
          rows="4"
          placeholder={contact.form.message.placeholder}
          class="w-full px-4 py-3 border-[1.5px] border-white rounded-2xl  bg-[#FFED7A] border-[#009337] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"
        ></textarea>
      </div>
    </div>
  ) : null}
  
  <!-- Submit Button -->
  <div>
    <button 
      type="submit"
      id="submitButton"
      class="w-full py-3 px-6 bg-[#009337] text-white uppercase font-bold text-2xl hover:bg-primary-dark transition-all rounded-full"
    >
      {contact.form.submit}
    </button>
  </div>
</form>
</div>

<!-- Success Modal -->
<SuccessModal 
  title={locale === 'es' ? "¡Gracias por contactarnos!" : "Thank you for contacting us!"}
  message={locale === 'es' ? "Hemos recibido tu mensaje. Te contactaremos pronto." : "We have received your message. We will contact you soon."}
  buttonText={locale === 'es' ? "Cerrar" : "Close"}
/>

<script is:inline data-astro-rerun>
  // @ts-nocheck
  (function () {
    'use strict';

    function hydrateConfig() {
      const container = document.getElementById('contactFormContainer');
      if (!(container instanceof HTMLElement)) return null;

      let parsedLabels = {};
      let parsedOptions = {};

      try {
        parsedLabels = JSON.parse(container.dataset.labels || '{}');
      } catch (e) {
        parsedLabels = {};
      }

      try {
        parsedOptions = JSON.parse(container.dataset.options || '{}');
      } catch (e) {
        parsedOptions = {};
      }

      return {
        locale: container.dataset.locale,
        formType: container.dataset.formType,
        hideContactReason: container.dataset.hideContactReason,
        apiHost: container.dataset.apiHost,
        apiToken: container.dataset.apiToken,
        contactFormPath: container.dataset.contactFormPath,
        departmentPlaceholder: container.dataset.departmentPlaceholder,
        countryPlaceholder: container.dataset.countryPlaceholder,
        labels: parsedLabels,
        options: parsedOptions
      };
    }

    // Variables usadas por la lógica existente (antes venían por define:vars)
    let departmentPlaceholder;
    let countryPlaceholder;
    let labels;
    let options;
    let locale;
    let formType;
    let hideContactReason;
    let apiHost;
    let apiToken;
    let contactFormPath;

    function bootWithConfig() {
      const cfg = hydrateConfig();
      if (!cfg) return;

      departmentPlaceholder = cfg.departmentPlaceholder;
      countryPlaceholder = cfg.countryPlaceholder;
      labels = cfg.labels;
      options = cfg.options;
      locale = cfg.locale;
      formType = cfg.formType;
      hideContactReason = cfg.hideContactReason;
      apiHost = cfg.apiHost;
      apiToken = cfg.apiToken;
      contactFormPath = cfg.contactFormPath;

      // Ejecuta la inicialización existente
      bootFormFunctionality();
    }

  // Countries data
  const countriesData = {
    'Guatemala': [
      'Guatemala', 'Alta Verapaz', 'Baja Verapaz', 'Chimaltenango', 'Chiquimula',
      'El Progreso', 'Escuintla', 'Huehuetenango', 'Izabal', 'Jalapa',
      'Jutiapa', 'Petén', 'Quetzaltenango', 'Quiché', 'Retalhuleu',
      'Sacatepéquez', 'San Marcos', 'Santa Rosa', 'Sololá', 'Suchitepéquez',
      'Totonicapán', 'Zacapa'
    ],
    'El Salvador': [
      'Ahuachapán', 'Cabañas', 'Chalatenango', 'Cuscatlán', 'La Libertad',
      'La Paz', 'La Unión', 'Morazán', 'San Miguel', 'San Salvador',
      'San Vicente', 'Santa Ana', 'Sonsonate', 'Usulután'
    ],
    'Honduras': [
      'Atlántida', 'Choluteca', 'Colón', 'Comayagua', 'Copán', 'Cortés',
      'El Paraíso', 'Francisco Morazán', 'Gracias a Dios', 'Intibucá',
      'Islas de la Bahía', 'La Paz', 'Lempira', 'Ocotepeque', 'Olancho',
      'Santa Bárbara', 'Valle', 'Yoro'
    ],
    'Nicaragua': [
      'Boaco', 'Carazo', 'Chinandega', 'Chontales', 'Estelí', 'Granada',
      'Jinotega', 'León', 'Madriz', 'Managua', 'Masaya', 'Matagalpa',
      'Nueva Segovia', 'Río San Juan', 'Rivas', 'Región Autónoma del Atlántico Norte',
      'Región Autónoma del Atlántico Sur'
    ],
    'Costa Rica': [
      'San José', 'Alajuela', 'Cartago', 'Heredia', 'Guanacaste', 'Puntarenas', 'Limón'
    ],
    'República Dominicana': [
      'Distrito Nacional', 'Azua', 'Baoruco', 'Barahona', 'Dajabón', 'Duarte',
      'Elías Piña', 'El Seibo', 'Espaillat', 'Hato Mayor', 'Hermanas Mirabal',
      'Independencia', 'La Altagracia', 'La Romana', 'La Vega', 'María Trinidad Sánchez',
      'Monseñor Nouel', 'Monte Cristi', 'Monte Plata', 'Pedernales', 'Peravia',
      'Puerto Plata', 'Samaná', 'San Cristóbal', 'San José de Ocoa', 'San Juan',
      'San Pedro de Macorís', 'Sánchez Ramírez', 'Santiago', 'Santiago Rodríguez',
      'Santo Domingo', 'Valverde'
    ]
  };

  // Simple file validation function
  function validateFile(file) {
    if (file.size > 10 * 1024 * 1024) {
      return { valid: false, error: locale === 'es' ? 'El archivo debe ser menor a 10MB' : 'File must be smaller than 10MB' };
    }
    
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
    if (!allowedTypes.includes(file.type)) {
      return { valid: false, error: locale === 'es' ? 'Solo se permiten archivos PDF, JPG y PNG' : 'Only PDF, JPG and PNG files are allowed' };
    }
    
    return { valid: true };
  }

  // Form submission function using the new API
  async function submitContactForm(formData) {
    try {
      // Handle "Enviar Hoja de vida" redirect case
      if (formData.contactReason === 'Enviar Hoja de vida') {
        window.location.href = 'https://www.dinant.com/buscamos-talento-como-tu/';
        return { success: true, message: 'Redirecting to careers page...' };
      }

      // Map contact reason to template
      function getTemplateByContactReason(contactReason) {
        const templateMap = {
          'Soy cliente': 'client',
          'Quiero ser cliente': 'ser_cliente',
          'Exportaciones': 'exportaciones',
          'Quiero ser proveedor': 'ser_proveedor',
          'Soy Estudiante Universitario': 'estudiante_universitario',
          'Soy Periodista/ Medio de comunicación': 'periodista_medio',
          'Línea Ética YUMMIES': 'linea_etica',
          'Otros': 'otros',
          'Soy un ganador': 'ganador',
          'zambostruck': 'zambostruck'
        };
        
        return templateMap[contactReason] || 'otros';
      }

      // Validate file if present
      if (formData.file && formData.file instanceof File && formData.file.size > 0) {
        const fileValidation = validateFile(formData.file);
        if (!fileValidation.valid) {
          return {
            success: false,
            message: fileValidation.error || 'Invalid file'
          };
        }
      }

      // Create FormData for multipart submission
      const multipartData = new FormData();

      // Add template field based on contact reason
      const template = getTemplateByContactReason(formData.contactReason);
      multipartData.append('template', template);
      multipartData.append('site', "Zambos");
      
      // Special handling for "Soy un ganador" - concatenate prefixes
      if (formData.contactReason === 'Soy un ganador') {
        if (formData.dynamicOrPromotion) {
          formData.dynamicOrPromotion = 'Dinámica o promoción: ' + formData.dynamicOrPromotion;
        }
        if (formData.award) {
          formData.award = 'Premio adjudicado: ' + formData.award;
        }
      }
      
      // Add all form fields according to the API structure
      Object.entries(formData).forEach(([key, value]) => {
        if (value !== undefined && value !== null && value !== '') {
          if (key === 'file' && value instanceof File) {
            // Add file with proper field name for attachments
            multipartData.append('attachments', value);
          } else {
            // Convert all other fields to string
            multipartData.append(key, String(value));
          }
        }
      });

      // Build full API URL
      const apiUrl = `${apiHost}${contactFormPath}`;

      console.log('Submitting contact form to:', apiUrl);
      console.log('Template for contact reason "' + formData.contactReason + '":', template);

      // Submit to API
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Authorization': apiToken
        },
        body: multipartData,
      });

      if (!response.ok) {
        let errorMessage = `HTTP error! status: ${response.status}`;
        
        try {
          const errorData = await response.json();
          errorMessage = errorData.message || errorData.error || errorMessage;
        } catch (parseError) {
          console.error('Error parsing error response:', parseError);
        }

        throw new Error(errorMessage);
      }

      const result = await response.json();
      return {
        success: true,
        message: result.message || (locale === 'es' ? 'Formulario enviado exitosamente' : 'Form submitted successfully'),
        data: result.data
      };

    } catch (error) {
      console.error('Contact form submission error:', error);
      return {
        success: false,
        message: error instanceof Error ? error.message : (locale === 'es' ? 'Error al enviar el formulario' : 'Error sending form')
      };
    }
  }

  let contactReasonSelect;
  let countrySelect;
  let citySelect;
  let dynamicFields;
  let form;

  // Initialize the form functionality
  function initFormFunctionality() {
    console.log('=== INITIALIZING CONTACT FORM ===');
    contactReasonSelect = document.getElementById('contactReasonSelect');
    countrySelect = document.getElementById('countrySelect');
    citySelect = document.getElementById('departmentSelect');
    dynamicFields = document.getElementById('dynamicFields');
    form = document.getElementById('contactForm');

    if (form && form.dataset.jsInitialized === 'true') {
      console.log('✓ Form already initialized, skipping');
      return;
    }

    // Debug: Check if elements exist
    console.log('✓ Form elements found:', {
      contactReasonSelect: !!contactReasonSelect,
      countrySelect: !!countrySelect,
      citySelect: !!citySelect,
      dynamicFields: !!dynamicFields,
      form: !!form,
      hideContactReason,
      formType
    });

    // Debug: Check if variables are passed correctly
    console.log('Script variables:', { labels, options, locale, apiHost, apiToken, contactFormPath });

    // If any of the required elements are missing, exit early
    // contactReasonSelect is optional when hideContactReason is enabled
    const requiresContactReasonSelect = hideContactReason !== 'true';
    if ((requiresContactReasonSelect && !contactReasonSelect) || !countrySelect || !citySelect || !dynamicFields || !form) {
      console.error('Required form elements not found');
      return;
    }

    form.dataset.jsInitialized = 'true';

    // Populate countries
    if (countrySelect) {
      // Make sure we don't add duplicates
      if (countrySelect.options.length <= 1) {
        Object.keys(countriesData).forEach(country => {
          const option = document.createElement('option');
          option.value = country;
          option.textContent = country;
          countrySelect.appendChild(option);
        });
      }
    }

    // Handle contact reason change
    if (contactReasonSelect) {
      contactReasonSelect.onchange = function() {
        const selectedReason = this.value;
        console.log('Contact reason changed to:', selectedReason);
        
        // Reset phone field requirement when changing contact reason
        const phoneInput = document.querySelector('input[name="phone"]');
        if (phoneInput) {
          phoneInput.removeAttribute('required');
          const phoneLabel = phoneInput.closest('.flex-1')?.querySelector('label');
          if (phoneLabel) {
            phoneLabel.innerHTML = phoneLabel.innerHTML.replace(' *', '');
          }
        }
        
        updateDynamicFields(selectedReason);
      };
    }

    // Handle country change
    countrySelect.onchange = function() {
      const selectedCountry = this.value;
      
      // Clear city options
      citySelect.innerHTML = `<option value="">${departmentPlaceholder}</option>`;
      
      if (selectedCountry && countriesData[selectedCountry]) {
        // Enable city select
        citySelect.disabled = false;
        citySelect.classList.remove('disabled:bg-gray-100', 'disabled:cursor-not-allowed');
        
        // Add cities for selected country
        countriesData[selectedCountry].forEach(function(city) {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      } else {
        // Disable city select if no country selected
        citySelect.disabled = true;
        citySelect.classList.add('disabled:bg-gray-100', 'disabled:cursor-not-allowed');
      }
    };

    // ZambosTruck: auto-select Honduras and populate cities
    if (hideContactReason === 'true' && formType === 'zambostruck' && countrySelect) {
      countrySelect.value = 'Honduras';
      if (typeof countrySelect.onchange === 'function') {
        countrySelect.onchange();
      }
    }

    // Handle form submission
    form.onsubmit = async function(e) {
      e.preventDefault();
      
      const submitButton = document.getElementById('submitButton');
      const originalText = submitButton ? submitButton.textContent : '';
      
      try {
        // Show loading state
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = locale === 'es' ? 'Enviando...' : 'Sending...';
        }
        
        // Get form data
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        // Convert phone to number if present
        if (data.phone && data.phone !== '') {
          data.phone = Number(data.phone);
        }
        
        // Handle file upload
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput && fileInput.files[0]) {
          data.file = fileInput.files[0];
        }
        
        console.log('Form data to submit:', data);
        
        // Submit form
        const result = await submitContactForm(data);
        
        if (result.success) {
          // Show success modal instead of alert
          if (window.showSuccessModal) {
            const successTitle = locale === 'es' ? '¡Gracias por tu mensaje!' : 'Thank you for your message!';
            const successMessage = locale === 'es' ? 'Hemos recibido tu información. Te contactaremos pronto.' : 'We have received your information. We will contact you soon.';
            window.showSuccessModal(successMessage, successTitle);
          } else {
            // Fallback to alert if modal function not available
            alert(locale === 'es' ? '¡Gracias por tu mensaje! Te contactaremos pronto.' : 'Thank you for your message! We will contact you soon.');
          }
          
          // Reset form
          this.reset();
          if (citySelect) {
            citySelect.disabled = true;
            citySelect.classList.add('disabled:bg-gray-100', 'disabled:cursor-not-allowed');
            citySelect.innerHTML = `<option value="">${departmentPlaceholder}</option>`;
          }
          if (dynamicFields) {
            dynamicFields.innerHTML = '';
          }
        } else {
          // Show error message
          alert(result.message);
        }
        
      } catch (error) {
        console.error('Form submission error:', error);
        alert(locale === 'es' ? 'Error al enviar el formulario' : 'Error sending form');
      } finally {
        // Restore button state
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      }
    };
    
    form.dataset.jsInitialized = 'true';
    
    console.log('✓ Event listeners attached');
    
    // Initialize dynamic fields
    if (hideContactReason === 'true' && formType === 'zambostruck') {
      updateDynamicFields('zambostruck');
    } else if (contactReasonSelect && contactReasonSelect.value) {
      console.log('→ Initializing with selected reason:', contactReasonSelect.value);
      updateDynamicFields(contactReasonSelect.value);
    }
    
    console.log('=== CONTACT FORM INITIALIZED ===');
  }

  function bootFormFunctionality() {
    initFormFunctionality();
  }

  const safeBoot = () => {
    try {
      bootWithConfig();
    } catch (err) {
      console.error('Error initializing contact form:', err);
    }
  };

  document.addEventListener('astro:page-load', safeBoot);
  document.addEventListener('astro:after-swap', safeBoot);
  window.addEventListener('load', safeBoot);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', safeBoot, { once: true });
  } else {
    safeBoot();
  }

  setTimeout(safeBoot, 0);

  // Function to update dynamic fields based on contact reason
  function updateDynamicFields(contactReason) {
    if (!dynamicFields) {
      console.error('Dynamic fields container not found');
      return;
    }
    
    console.log('Updating dynamic fields for reason:', contactReason);
    
    // Clear existing dynamic fields
    dynamicFields.innerHTML = '';
    
    // Handle redirect case
    if (contactReason === 'Enviar Hoja de vida') {
      window.location.href = 'https://www.dinant.com/buscamos-talento-como-tu/';
      return;
    }
    
    // Create dynamic fields based on contact reason
    switch (contactReason) {
      case 'Soy cliente':
        createClientFields();
        break;
      case 'Quiero ser cliente':
        createProspectiveClientFields();
        break;
      case 'Exportaciones':
        createExportsFields();
        break;
      case 'Quiero ser proveedor':
        createSupplierFields();
        break;
      case 'Soy Estudiante Universitario':
        createStudentFields();
        break;
      case 'Soy Periodista/ Medio de comunicación':
        createJournalistFields();
        break;
      case 'Línea Ética YUMMIES':
        createEthicsLineFields();
        break;
      case 'Soy un ganador':
        createWinnerFields();
        break;
      case 'Otros':
        createOthersFields();
        break;
      case 'zambostruck':
        createZambosTruckFields();
        break;
      default:
        console.log('No specific fields for reason:', contactReason);
    }
  }

  function createZambosTruckFields() {
    const labelEventPlace = locale === 'es' ? 'Lugar del evento' : 'Event location';
    const labelPack = locale === 'es' ? 'Pack para cotizar' : 'Pack to quote';
    const labelEventType = locale === 'es' ? 'Tipo de evento' : 'Event type';
    const labelSchedule = locale === 'es' ? 'Horario de evento' : 'Event schedule';
    const labelDate = locale === 'es' ? 'Fecha de evento' : 'Event date';

    const placeholderEventPlace = locale === 'es' ? 'Ingresa el lugar del evento' : 'Enter event location';

    const packOptions = ['35 packs', '50 packs', '75 packs', '100 packs', '125 packs', '150 packs', '175 packs', '200 packs', '250 packs', '300 packs'];
    const eventTypes = locale === 'es'
      ? ['Bodas', 'Cumpleaños', 'Aniversarios', 'Eventos Corporativos', 'Conciertos', 'Eventos Deportivos', 'Reuniones Privadas']
      : ['Weddings', 'Birthdays', 'Anniversaries', 'Corporate events', 'Concerts', 'Sports events', 'Private meetings'];

    dynamicFields.innerHTML = `
      <div>
        <label class="block text-[#009337] uppercase font-semibold mb-2">${labelEventPlace} *</label>
        <input
          type="text"
          name="eventPlace"
          required
          placeholder="${placeholderEventPlace}"
          class="w-full font-semibold uppercase placeholder:text-[#009337] flex justify-center text-[#009337] items-center gap-5 p-[15px_20px] border-[1.5px] border-white rounded-full bg-[#FFED7A] border-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
        />
      </div>

      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <label class="block text-[#009337] uppercase font-semibold mb-2">${labelPack} *</label>
          <select
            name="quotePack"
            required
            class="w-full font-semibold uppercase flex justify-center text-[#009337] items-center gap-5 p-[15px_20px] border-[1.5px] border-white rounded-full bg-[#FFED7A] border-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
          >
            <option value="">${locale === 'es' ? 'Selecciona una opción' : 'Select an option'}</option>
            ${packOptions.map(p => `<option value="${p}">${p}</option>`).join('')}
          </select>
        </div>

        <div class="flex-1">
          <label class="block text-[#009337] uppercase font-semibold mb-2">${labelEventType} *</label>
          <select
            name="eventType"
            required
            class="w-full font-semibold uppercase flex justify-center text-[#009337] items-center gap-5 p-[15px_20px] border-[1.5px] border-white rounded-full bg-[#FFED7A] border-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
          >
            <option value="">${locale === 'es' ? 'Selecciona una opción' : 'Select an option'}</option>
            ${eventTypes.map(t => `<option value="${t}">${t}</option>`).join('')}
          </select>
        </div>
      </div>

      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <label class="block text-[#009337] uppercase font-semibold mb-2">${labelSchedule} *</label>
          <input
            type="time"
            name="eventSchedule"
            required
            class="w-full font-semibold uppercase flex justify-center text-[#009337] items-center gap-5 p-[15px_20px] border-[1.5px] border-white rounded-full bg-[#FFED7A] border-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
          />
        </div>

        <div class="flex-1">
          <label class="block text-[#009337] uppercase font-semibold mb-2">${labelDate} *</label>
          <input
            type="text"
            name="eventDate"
            required
            inputmode="numeric"
            autocomplete="off"
            maxlength="10"
            placeholder="DD/MM/YYYY"
            pattern="\\d{2}/\\d{2}/\\d{4}"
            class="w-full font-semibold uppercase flex justify-center text-[#009337] items-center gap-5 p-[15px_20px] border-[1.5px] border-white rounded-full bg-[#FFED7A] border-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
          />
        </div>
      </div>
    `;

    const eventDateInput = dynamicFields.querySelector('input[name="eventDate"]');

    const formatEventDate = (digits) => {
      const d = digits.slice(0, 8);
      const dd = d.slice(0, 2);
      const mm = d.slice(2, 4);
      const yyyy = d.slice(4, 8);
      let out = '';
      if (dd) out += dd;
      if (mm) out += `/${mm}`;
      if (yyyy) out += `/${yyyy}`;
      return out;
    };

    const parseEventDate = (value) => {
      const m = String(value || '').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (!m) return null;
      const day = Number(m[1]);
      const month = Number(m[2]);
      const year = Number(m[3]);
      if (!Number.isFinite(day) || !Number.isFinite(month) || !Number.isFinite(year)) return null;
      if (year < 1900 || year > 3000) return null;
      if (month < 1 || month > 12) return null;
      if (day < 1 || day > 31) return null;
      const date = new Date(year, month - 1, day);
      if (
        date.getFullYear() !== year ||
        date.getMonth() !== month - 1 ||
        date.getDate() !== day
      ) return null;
      return date;
    };

    const validateEventDate = () => {
      if (!eventDateInput) return;

      const value = eventDateInput.value;
      const parsed = parseEventDate(value);
      if (!parsed) {
        eventDateInput.setCustomValidity(locale === 'es' ? 'Fecha inválida. Usa DD/MM/YYYY.' : 'Invalid date. Use DD/MM/YYYY.');
        return;
      }
      const today = new Date();
      const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      if (parsed.getTime() <= todayStart.getTime()) {
        eventDateInput.setCustomValidity(locale === 'es' ? 'La fecha debe ser mayor a hoy.' : 'Date must be greater than today.');
        return;
      }
      eventDateInput.setCustomValidity('');
    };

    if (eventDateInput) {
      eventDateInput.addEventListener('input', (e) => {
        const target = e.currentTarget;
        if (!(target instanceof HTMLInputElement)) return;
        const digits = target.value.replace(/\D/g, '');
        target.value = formatEventDate(digits);
        validateEventDate();
      });
      eventDateInput.addEventListener('blur', () => {
        validateEventDate();
        eventDateInput.reportValidity();
      });
    }
  }

  // Field creation functions
  function createClientFields() {
    if (!labels || !options) {
      console.error('Labels or options not available');
      return;
    }
    
    dynamicFields.innerHTML = `
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.clientCode}</label>
        <input type="text" name="clientCode" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.areaOfInterest} *</label>
        <select name="interestArea" required class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
          <option value="">${locale === 'es' ? 'Selecciona una opción' : 'Select an option'}</option>
          ${options.clientAreaOfInterest.map(option => `<option value="${option}">${option}</option>`).join('')}
        </select>
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.message}</label>
        <textarea name="message" rows="4" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"></textarea>
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.file}</label>
        <input type="file" name="file" accept=".pdf,.jpg,.jpeg,.png" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
        <p class="text-sm text-[#009337] mt-1">${labels.fileHelp}</p>
      </div>
    `;
  }

  function createProspectiveClientFields() {
    if (!labels || !options) return;
    
    dynamicFields.innerHTML = `
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.requestType} *</label>
        <select name="requestType" required class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
          <option value="">${locale === 'es' ? 'Selecciona una opción' : 'Select an option'}</option>
          ${options.requestTypes.map(option => `<option value="${option}">${option}</option>`).join('')}
        </select>
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.file}</label>
        <input type="file" name="file" accept=".pdf,.jpg,.jpeg,.png" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
        <p class="text-sm text-[#009337] mt-1">${labels.fileHelp}</p>
      </div>
    `;
  }

  function createExportsFields() {
    if (!labels || !options) return;
    
    dynamicFields.innerHTML = `
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.interest} *</label>
        <select name="interest" required class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
          <option value="">${locale === 'es' ? 'Selecciona una opción' : 'Select an option'}</option>
          ${options.exportInterests.map(option => `<option value="${option}">${option}</option>`).join('')}
        </select>
      </div>
    `;
  }

  function createSupplierFields() {
    if (!labels) return;
    
    dynamicFields.innerHTML = `
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.areaOfInterestSupplier} *</label>
        <input type="text" name="areaOfInterest" required class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.file}</label>
        <input type="file" name="file" accept=".pdf,.jpg,.jpeg,.png" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
        <p class="text-sm text-[#009337] mt-1">${labels.fileHelp}</p>
      </div>
    `;
  }

  function createStudentFields() {
    if (!labels) return;
    
    dynamicFields.innerHTML = `
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.question} *</label>
        <textarea name="question" required rows="4" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"></textarea>
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.file}</label>
        <input type="file" name="file" accept=".pdf,.jpg,.jpeg,.png" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
        <p class="text-sm text-[#009337] mt-1">${labels.fileHelp}</p>
      </div>
    `;
  }

  function createJournalistFields() {
    if (!labels || !options) return;
    
    dynamicFields.innerHTML = `
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.areaOfInterest} *</label>
        <select name="areaOfInterest" required class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
          <option value="">${locale === 'es' ? 'Selecciona una opción' : 'Select an option'}</option>
          ${options.journalistAreas.map(option => `<option value="${option}">${option}</option>`).join('')}
        </select>
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.question} *</label>
        <textarea name="question" required rows="4" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"></textarea>
      </div>
    `;
  }

  function createEthicsLineFields() {
    if (!labels) return;
    
    dynamicFields.innerHTML = `
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.comments || 'Comentarios'} *</label>
        <textarea name="message" required rows="4" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"></textarea>
        <p class="text-sm text-[#009337] mt-1">${labels.ethicsLineHelp || 'Si eres empleado Dinant, especifica tu cargo.'}</p>
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.file || 'Adjuntar archivo'}</label>
        <input type="file" name="file" accept=".pdf,.jpg,.jpeg,.png" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
        <p class="text-sm text-[#009337] mt-1">${labels.fileHelp || 'Formatos permitidos: PDF, JPG, PNG (max 10MB)'}</p>
      </div>
    `;
  }
  
  function createWinnerFields() {
    if (!labels) return;
    
    // Solo disponible en español
    if (locale !== 'es') {
      dynamicFields.innerHTML = `
        <div class="alert alert-info">
          <p>Esta opción solo está disponible en español.</p>
        </div>
      `;
      return;
    }
    
    // Hacer el campo de teléfono obligatorio
    const phoneInput = document.querySelector('input[name="phone"]');
    if (phoneInput) {
      phoneInput.setAttribute('required', 'required');
      const phoneLabel = phoneInput.closest('.flex-1')?.querySelector('label');
      if (phoneLabel && !phoneLabel.textContent?.includes('*')) {
        phoneLabel.innerHTML = phoneLabel.innerHTML + ' *';
      }
    }
    
    dynamicFields.innerHTML = `
      <div>
        <label class="block text-[#009337] font-medium mb-2">Dinámica o promoción en la que ganó *</label>
        <input type="text" name="dynamicOrPromotion" required class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">Premio adjudicado *</label>
        <input type="text" name="award" required class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">Mensaje</label>
        <textarea name="winnerMessage" rows="4" placeholder="Escribe la promoción en la que ganaste o detalla el premio que ganaste. Ej: PS5, giftcards, etc." class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] placeholder:opacity-70 focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"></textarea>
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.file || 'Adjuntar archivo'}</label>
        <input type="file" name="file" accept=".pdf,.jpg,.jpeg,.png" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
        <p class="text-sm text-[#009337] mt-1">${labels.fileHelp || 'Formatos permitidos: PDF, JPG, PNG (max 10MB)'}</p>
      </div>
    `;
  }

  function createOthersFields() {
    if (!labels) return;
    
    dynamicFields.innerHTML = `
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.message}</label>
        <textarea name="message" rows="4" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all resize-none"></textarea>
      </div>
      <div>
        <label class="block text-[#009337] font-medium mb-2">${labels.file}</label>
        <input type="file" name="file" accept=".pdf,.jpg,.jpeg,.png" class="w-full px-4 py-3 border-[1.5px] border-[#009337] rounded-2xl bg-[#FFED7A] text-[#009337] placeholder:text-[#009337] focus:text-black focus:bg-white focus:ring-2 focus:ring-primary focus:border-transparent transition-all" />
        <p class="text-sm text-[#009337] mt-1">${labels.fileHelp}</p>
      </div>
    `;
  }
  })();
</script>
