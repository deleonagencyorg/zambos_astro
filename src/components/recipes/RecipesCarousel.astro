---
import RecipeCard from './RecipeCard.astro';
import { getLocale } from '../../i18n/i18n';

// Import all recipe files dynamically (use static glob and filter by lang)
const currentLang = getLocale();
interface Recipe {
  id: string;
  title: string;
  image: string;
  hover_image?: string;
  preparation_time: number;
  category?: string;
  category_en?: string;
  categories?: string[];
  categories_en?: string[];
  difficulty?: string;
  servings?: number;
  rating?: number;
}

// Optional items can be passed from parent (e.g., related recipes)
export interface Props {
  title?: string;
  textButton?: string;
  items?: any[]; // permitir arrays compatibles (e.g., RecipeItem)
}

const {
  textButton = currentLang === 'es' ? 'Ver Todas' : 'View All',
  items
} = Astro.props as { textButton?: string; items?: any[] };

// If items provided, use them; otherwise load all by lang
let recipeItems: Recipe[] = Array.isArray(items) ? (items as unknown as Recipe[]) : [];
if (!recipeItems.length) {
  const recipeModules = import.meta.glob<{ default: Recipe }>("../../locales/*/recipes/*.json");
  for (const path in recipeModules) {
    const lang = path.split('/') [3];
    if (lang === currentLang) {
      const mod = await recipeModules[path]();
      recipeItems.push(mod.default);
    }
  }
}

// Determine if we are in provided-items mode (hide filters/CTA)
const providedMode = Array.isArray(items) && items.length > 0;

// Normalizar categoría (usando claves en inglés para el filtrado)
function getCategoryKey(recipe: any): string {
  const raw = (
    recipe?.category_en ||
    recipe?.category ||
    recipe?.category?.name ||
    (Array.isArray(recipe?.categories_en) ? recipe.categories_en[0] : undefined) ||
    (Array.isArray(recipe?.categories) ? recipe.categories[0] : undefined) ||
    ''
  );
  const key = String(raw || '').trim().toLowerCase();
  // mapear posibles variaciones a claves conocidas
  if (['breakfast', 'desayuno'].includes(key)) return 'breakfast';
  if (['brunch'].includes(key)) return 'brunch';
  if (['lunch', 'almuerzo'].includes(key)) return 'lunch';
  return key || 'other';
}

// Etiquetas por idioma (solo UI)
const filterLabels = currentLang === 'es'
  ? { breakfast: 'DESAYUNO', brunch: 'BRUNCH', lunch: 'ALMUERZO', all: 'TODO' }
  : { breakfast: 'BREAKFAST', brunch: 'BRUNCH', lunch: 'LUNCH', all: 'ALL' };

// Para desktop: mostrar 4 tarjetas por vista, avanzar de 1 en 1
// Para mobile: 1 por slide (agrupadas de a 1)
const mobileGroups = [] as any[];
for (let i = 0; i < recipeItems.length; i += 1) {
  mobileGroups.push([recipeItems[i]].filter(Boolean));
}

---

<div class="w-full" data-recipes-carousel>
  <div class="w-full px-4 ">
    <!-- Título alineado a la izquierda -->
    
    <!-- Seccion de recetas -->
    
    <!-- Botones de filtro -->
    {!providedMode && (
    <div class="flex gap-2.5 mb-8 px-4 md:px-0 justify-center" id="recipesFilters">
      <button type="button" data-filter="breakfast" class="filter-btn flex py-5 px-2.5 justify-center items-center gap-2.5 flex-1  text-xl rounded-full border border-brown bg-yellow font-bold text-brown hover:bg-yellow-400 transition-colors">
        {filterLabels.breakfast}
      </button>
      <button type="button" data-filter="brunch" class="filter-btn flex py-5 px-2.5 justify-center items-center gap-2.5 flex-1 text-xl rounded-full border border-brown bg-yellow font-bold text-brown hover:bg-yellow-400 transition-colors">
        {filterLabels.brunch}
      </button>
      <button type="button" data-filter="lunch" class="filter-btn flex py-5 px-2.5 justify-center items-center gap-2.5 flex-1 text-xl rounded-full border border-brown bg-yellow font-bold text-brown hover:bg-yellow-400 transition-colors">
        {filterLabels.lunch}
      </button>
      <button type="button" data-filter="all" class="filter-btn flex py-5 px-2.5 justify-center items-center gap-2.5 flex-1 text-xl rounded-full border border-brown bg-yellow font-bold text-brown hover:bg-yellow-400 transition-colors">
        {filterLabels.all}
      </button>
    </div>
    )}

    {providedMode ? (
      <div class="w-full" data-recipes-carousel-provided>
        <div class="relative w-full">
          <div class="overflow-hidden w-full">
            <div
              class="flex items-stretch gap-4 transition-transform duration-300 will-change-transform"
              data-recipes-provided-track
              style="transform: translateX(0);"
            >
              {recipeItems.map((recipe) => (
                <div class="flex-shrink-0 w-full sm:w-[48%] md:w-[31%]" data-recipes-provided-item>
                  <RecipeCard
                    image={recipe.image}
                    title={recipe.title}
                    time={`${recipe.preparation_time}MIN`}
                    id={recipe.id}
                    description={(recipe as any).description}
                    category={(recipe as any).category || 'breakfast'}
                    isNew={(recipe as any).isNew || false}
                  />
                </div>
              ))}
            </div>
          </div>

          <div class="flex justify-center items-center gap-4 mt-6">
            <button
              type="button"
              aria-label="Anterior"
              data-recipes-provided-prev
              class="bg-red text-white p-4 rounded-[10px] shadow-lg"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>

            <button
              type="button"
              aria-label="Siguiente"
              data-recipes-provided-next
              class="bg-red text-white p-4 rounded-[10px] shadow-lg"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    ) : (
    <div>
      <!-- Carousel de recetas - MOBILE (1 por slide) - Solo visible en mobile -->
      <div class="recipes-carousel-mobile relative md:hidden">
        <div class="recipes-carousel-container overflow-hidden w-full flex justify-center">
          <div class="recipes-carousel-track flex items-center gap-0 transition-transform duration-300" id="recipesTrackMobile" style="transform: translateX(0);">
            {mobileGroups.map((group, gIndex) => (
              <div class="recipe-slide-group flex-shrink-0 w-full flex justify-center items-center px-4">
                {group.map((recipe: any) => (
                  <div class="recipe-slide flex justify-center" data-category={getCategoryKey(recipe)}>
                    <RecipeCard
                      image={recipe.image}
                      title={recipe.title}
                      time={`${recipe.preparation_time}MIN`}
                      id={recipe.id}
                      description={(recipe as any).description}
                      category={getCategoryKey(recipe).toUpperCase()}
                      isNew={(recipe as any).isNew || false}
                    />
                  </div>
                ))}
              </div>
            ))}
          </div>
        </div>

        <!-- Controles de navegación mobile (flechas y puntos) -->
        <div class="flex justify-center items-center gap-4 mt-6">
          <button class="carousel-prev bg-white text-brown p-2 rounded-full shadow-lg z-10" aria-label="Anterior" id="prevBtnMobile">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>

          <div class="carousel-dots-mobile flex gap-2"></div>

          <button class="carousel-next bg-white text-brown p-2 rounded-full shadow-lg z-10" aria-label="Siguiente" id="nextBtnMobile">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Carousel de recetas - DESKTOP - Solo visible en desktop -->
      <div class="recipes-carousel relative hidden md:block">
        <div class="recipes-carousel-container overflow-visible ">
          <div class="recipes-carousel-track flex items-start justify-center w-full gap-4 md:gap-6 transition-transform duration-300" id="recipesTrackDesktop" style="transform: translateX(0);">
            {recipeItems.map((recipe, index) => (
              <div class="recipe-slide flex-shrink-0 group-hover-container" data-index={index} data-category={getCategoryKey(recipe)}>
                <RecipeCard
                  image={recipe.image}
                  title={recipe.title}
                  time={`${recipe.preparation_time}MIN`}
                  id={recipe.id}
                  description={(recipe as any).description}
                  category={getCategoryKey(recipe).toUpperCase()}
                  isNew={(recipe as any).isNew || false}
                />
              </div>
            ))}
          </div>
        </div>

        <div class="flex justify-center mt-8">
          <button
            type="button"
            id="loadMoreDesktop"
            class="bg-yellow text-brown font-bold py-3 px-10 rounded-full hover:border-brown hover:border-2 hover:bg-brown hover:text-yellow transition-colors"
          >
            {currentLang === 'es' ? 'Cargar más' : 'Load more'}
          </button>
        </div>
      </div>
      
      <!-- Botón "Ver Todas" - oculto cuando se proveen items -->
      {!providedMode && (
      <div class="flex justify-center mt-6 w-full px-4 md:px-0">
        <a href={`/${currentLang === 'es' ? 'es/recetas' : 'en/recipes'}`} class="bg-yellow text-brown font-bold py-2 px-8 rounded-full hover:border-brown hover:border-2 hover:bg-brown hover:text-yellow transition-colors w-full md:w-auto text-center font-title text-2xl">
          {textButton}
        </a>
      </div>
      )}
    </div>
    )}
  </div>
</div>

<script>
  function initRecipesCarousel(root: any) {
    if (!root || root.dataset.rcInitialized === 'true') return;
    root.dataset.rcInitialized = 'true';

    // Modo "items provistos" (e.g., recetas recomendadas en detalle)
    const providedRoot = root.querySelector('[data-recipes-carousel-provided]');
    if (providedRoot) {
      const track = root.querySelector('[data-recipes-provided-track]');
      const prevBtn = root.querySelector('[data-recipes-provided-prev]');
      const nextBtn = root.querySelector('[data-recipes-provided-next]');

      if (!track || !prevBtn || !nextBtn) return;

      const items = Array.from(track.querySelectorAll('[data-recipes-provided-item]')) as any[];
      if (!items.length) return;

      let index = 0;

      function perView() {
        const w = window.innerWidth;
        if (w < 319) return 1;
        if (w < 768) return 2;
        return 3;
      }

      function gapPx() {
        const styles = window.getComputedStyle(track);
        const gap = styles.gap || styles.columnGap || '0px';
        const n = Number.parseFloat(gap);
        return Number.isFinite(n) ? n : 0;
      }

      function applyItemWidths() {
        const pv = perView();
        const g = gapPx();
        items.forEach((el: any) => {
          el.style.flex = `0 0 calc((100% - ${(pv - 1) * g}px) / ${pv})`;
        });
      }

      function stepPx() {
        const first = items[0] as any;
        if (!first) return 0;
        return first.getBoundingClientRect().width + gapPx();
      }

      function maxIndex() {
        return Math.max(0, items.length - perView());
      }

      function update() {
        applyItemWidths();
        index = Math.min(index, maxIndex());
        const step = stepPx();
        track.style.transform = `translateX(-${index * step}px)`;
        prevBtn.classList.toggle('opacity-50', index === 0);
        nextBtn.classList.toggle('opacity-50', index >= maxIndex());
      }

      prevBtn.addEventListener('click', () => {
        index = Math.max(0, index - 1);
        update();
      });
      nextBtn.addEventListener('click', () => {
        index = Math.min(maxIndex(), index + 1);
        update();
      });
      window.addEventListener('resize', () => {
        update();
      });

      update();
      return;
    }

    // Estado de filtro actual
    let currentFilter = 'all';

    // Setup filtros
    const filtersContainer = root.querySelector('#recipesFilters');
    const filterButtons = Array.from(filtersContainer?.querySelectorAll('.filter-btn') || []) as any[];

    // Configuración para el carrusel mobile
    setupMobileCarousel();

    // Configuración para el carrusel desktop
    setupDesktopCarousel();

    // Eventos de filtros
    filterButtons.forEach((btn: any) => {
      btn.addEventListener('click', () => {
        const filter = btn.getAttribute('data-filter') || 'all';
        currentFilter = filter;
        // estilos activos
        filterButtons.forEach((b: any) => b.classList.remove('ring-2', 'ring-brown'));
        btn.classList.add('ring-2', 'ring-brown');
        // aplicar filtros
        applyFilterMobile();
        applyFilterDesktop();
      });
    });

    // Función para configurar el carrusel mobile
    function setupMobileCarousel() {
      applyFilterMobile(true);
    }

    function applyFilterMobile(initial = false) {
      const track = root.querySelector('#recipesTrackMobile');
      const prevBtn = root.querySelector('#prevBtnMobile');
      const nextBtn = root.querySelector('#nextBtnMobile');
      const dotsContainer = root.querySelector('.carousel-dots-mobile');

      if (!track || !prevBtn || !nextBtn || !dotsContainer) return;

      const allGroups = Array.from(track.querySelectorAll('.recipe-slide-group')) as any[];
      // Mostrar/ocultar grupos según filtro (cada grupo tiene 1 slide)
      allGroups.forEach((group: any) => {
        const slide = group.querySelector('.recipe-slide');
        const cat = slide?.getAttribute('data-category') || '';
        const visible = (currentFilter === 'all') || (cat === currentFilter);
        group.style.display = visible ? '' : 'none';
      });

      const visibleGroups = allGroups.filter((g: any) => g.style.display !== 'none');
      let currentGroup = 0;
      let autoplayInterval: any;

      // Handlers prev/next: reset listeners para evitar acumulación
      const prevClone = prevBtn.cloneNode(true);
      const nextClone = nextBtn.cloneNode(true);
      prevBtn.parentNode?.replaceChild(prevClone, prevBtn);
      nextBtn.parentNode?.replaceChild(nextClone, nextBtn);

      createDots();
      updatePosition();
      startAutoplay();

      prevClone.addEventListener('click', () => {
        stopAutoplay();
        if (currentGroup > 0) {
          currentGroup--;
          updatePosition();
        }
        startAutoplay();
      });

      nextClone.addEventListener('click', () => {
        stopAutoplay();
        if (currentGroup < visibleGroups.length - 1) {
          currentGroup++;
          updatePosition();
        }
        startAutoplay();
      });

      function createDots() {
        dotsContainer.innerHTML = '';
        for (let i = 0; i < visibleGroups.length; i++) {
          const dot = document.createElement('button');
          dot.classList.add('w-3', 'h-3', 'rounded-full', i === currentGroup ? 'bg-white' : 'bg-gray-300');
          dot.addEventListener('click', () => {
            stopAutoplay();
            currentGroup = i;
            updatePosition();
            startAutoplay();
          });
          dotsContainer.appendChild(dot);
        }
      }

      function updatePosition() {
        // Calcular índice real de grupo visible
        const targetGroup = visibleGroups[currentGroup];
        const originalIndex = allGroups.indexOf(targetGroup);
        const percent = Math.max(0, originalIndex) * 100;
        track.style.transform = `translateX(-${percent}%)`;

        // Actualizar dots
        const dots = dotsContainer.querySelectorAll('button') as any;
        dots.forEach((dot: any, i: any) => {
          if (i === currentGroup) {
            dot.classList.remove('bg-gray-300');
            dot.classList.add('bg-white');
          } else {
            dot.classList.remove('bg-white');
            dot.classList.add('bg-gray-300');
          }
        });

        // Habilitar/deshabilitar botones
        prevClone.classList.toggle('opacity-50', currentGroup === 0);
        nextClone.classList.toggle('opacity-50', currentGroup >= visibleGroups.length - 1);
      }

      function startAutoplay() {
        stopAutoplay();
        autoplayInterval = setInterval(() => {
          if (currentGroup < visibleGroups.length - 1) {
            currentGroup++;
          } else {
            currentGroup = 0;
          }
          updatePosition();
        }, 4000);
      }

      function stopAutoplay() {
        if (autoplayInterval) {
          clearInterval(autoplayInterval);
          autoplayInterval = null;
        }
      }

      // Pausar autoplay cuando el usuario interactúa
      track.addEventListener('mouseenter', stopAutoplay);
      track.addEventListener('mouseleave', startAutoplay);
      track.addEventListener('touchstart', stopAutoplay);
    }

    // Función para configurar el carrusel desktop
    function setupDesktopCarousel() {
      applyFilterDesktop(true);
    }

    function applyFilterDesktop(initial = false) {
      const track = root.querySelector('#recipesTrackDesktop');
      const loadMoreBtn = root.querySelector('#loadMoreDesktop');

      if (!track || !loadMoreBtn) return;

      function gapPx() {
        const styles = window.getComputedStyle(track);
        const gap = styles.gap || styles.columnGap || '0px';
        const n = Number.parseFloat(gap);
        return Number.isFinite(n) ? n : 0;
      }

      function perView() {
        // Desktop/Tablet: 3 cards. Mobile uses the separate mobile carousel.
        return 3;
      }

      const allSlides = Array.from(track.querySelectorAll('.recipe-slide')) as any[];
      const pageSize = 4;
      let revealedCount = pageSize;

      const loadMoreClone = loadMoreBtn.cloneNode(true);
      loadMoreBtn.parentNode?.replaceChild(loadMoreClone, loadMoreBtn);

      const computeFilteredSlides = () => {
        allSlides.forEach((slide) => {
          const cat = slide.getAttribute('data-category') || '';
          const matches = (currentFilter === 'all') || (cat === currentFilter);
          slide.dataset.matchesFilter = matches ? 'true' : 'false';
        });
        return allSlides.filter(s => s.dataset.matchesFilter === 'true');
      };

      const filteredSlides = computeFilteredSlides();

      function updateDesktopView() {
        const slidesToShow = filteredSlides.slice(0, revealedCount);
        allSlides.forEach((slide) => {
          if (slide.dataset.matchesFilter === 'true' && slidesToShow.includes(slide)) {
            slide.style.display = 'block';
          } else {
            slide.style.display = 'none';
          }
        });

        // Ajustar anchos en % para evitar cortes al cambiar el tamaño.
        const pv = perView();
        const g = gapPx();
        slidesToShow.forEach((slide) => {
          slide.style.flex = `0 0 calc((100% - ${(pv - 1) * g}px) / ${pv})`;
          slide.style.maxWidth = `calc((100% - ${(pv - 1) * g}px) / ${pv})`;
          slide.style.transition = 'none';
        });

        slidesToShow.forEach((slide) => {
          let card = slide.querySelector('a');
          if (card) {
            // Remover listeners previos clonando el elemento
            const newCard = card.cloneNode(true) as any;
            card.parentNode?.replaceChild(newCard, card);
            card = newCard;

            // Resetear a estado normal (sin opacidad baja ni expansión)
            card.style.opacity = '1';
            card.style.zIndex = '';
            card.className = 'block group relative transition-all duration-300 ease-in-out flex-shrink-0 w-full';

            const cardContainer = card.querySelector('div');
            const imgContainer = cardContainer?.querySelector('div[class*="rounded-t-"]');
            const infoContainer = cardContainer?.querySelector('div[class*="bg-[#F8E31F]"]');
            const title = card.querySelector('h3');
            const imgTag = imgContainer?.querySelector('img');

            if (cardContainer) cardContainer.style.width = '100%';
            if (imgContainer) imgContainer.style.width = '100%';
            if (infoContainer) infoContainer.style.width = '100%';
            if (title) title.className = 'font-title font-bold text-black leading-tight flex-1 flex items-center text-brown text-2xl';
            if (imgTag) imgTag.className = 'w-full h-full object-cover';
          }
        });

        loadMoreClone.classList.toggle('hidden', revealedCount >= filteredSlides.length);
      }

      if (root.dataset.rcDesktopResizeBound !== 'true') {
        root.dataset.rcDesktopResizeBound = 'true';
        window.addEventListener('resize', () => {
          updateDesktopView();
        });
      }

      loadMoreClone.addEventListener('click', () => {
        revealedCount = Math.min(filteredSlides.length, revealedCount + pageSize);
        updateDesktopView();
      });

      updateDesktopView();
    }
  }

  // Inicializaciones para navegaciones parciales de Astro y carga inicial
  function initAll() {
    document.querySelectorAll('[data-recipes-carousel]')
      .forEach((el) => initRecipesCarousel(el));
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    initAll();
  }
  document.addEventListener('astro:page-load', initAll);
  document.addEventListener('astro:after-swap', initAll);
</script>
