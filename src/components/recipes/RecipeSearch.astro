---
import { getLocale } from '../../i18n/i18n';

interface Item {
  id: string;
  title: string;
}

export interface Props {
  items: Item[];
  placeholder?: string;
}

const { items, placeholder = 'Searchâ€¦' } = Astro.props;
const currentLocale = getLocale();
const basePath = `/${currentLocale}/${currentLocale === 'es' ? 'recetas' : 'recipes'}`;
---

<div class="relative recipe-search-component">
  <input
    type="text"
    class="recipe-search-input w-full px-12 py-4 rounded-full text-gray-700 focus:outline-none focus:ring-2 focus:ring-white"
    placeholder={placeholder}
    autocomplete="off"
    data-items={JSON.stringify(items)}
    data-base-path={basePath}
  />

  <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
  </svg>

  <div
    class="recipe-search-suggestions hidden absolute left-0 right-0 mt-2 bg-white rounded-2xl shadow-xl overflow-hidden z-50"
  ></div>
</div>

<script>
  function initializeRecipeSearch() {
    const components = document.querySelectorAll('.recipe-search-component');
    
    components.forEach((root) => {
      const input = root.querySelector('.recipe-search-input') as HTMLInputElement;
      const suggestions = root.querySelector('.recipe-search-suggestions') as HTMLElement;

      if (!input || !suggestions) return;

      // Parse data from attributes
      let data: Array<{id: string, title: string}> = [];
      let basePath = '';
      
      try {
        const itemsStr = input.getAttribute('data-items');
        if (itemsStr) {
          data = JSON.parse(itemsStr);
        }
        basePath = input.getAttribute('data-base-path') || '';
      } catch (e) {
        console.error('Error parsing recipe search data:', e);
        return;
      }

      function escapeHtml(str: string) {
        return String(str)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      function hideSuggestions() {
        suggestions.classList.add('hidden');
        suggestions.innerHTML = '';
      }

      function showSuggestions(html: string) {
        suggestions.innerHTML = html;
        suggestions.classList.remove('hidden');
      }

      function buildSuggestions(query: string) {
        const q = query.trim().toLowerCase();
        if (!q) {
          hideSuggestions();
          return;
        }

        const matches = data
          .filter((r) => (r?.title || '').toLowerCase().includes(q))
          .slice(0, 6);

        if (!matches.length) {
          hideSuggestions();
          return;
        }

        const html = `
          <ul class="py-2">
            ${matches
              .map(
                (r) => `
                <li>
                  <a
                    class="block px-6 py-3 hover:bg-gray-100 text-gray-800"
                    href="${basePath}/${encodeURIComponent(r.id)}"
                  >
                    ${escapeHtml(r.title)}
                  </a>
                </li>
              `
              )
              .join('')}
          </ul>
        `;

        showSuggestions(html);
      }

      // Remove old listeners by cloning and replacing the input
      const newInput = input.cloneNode(true) as HTMLInputElement;
      input.parentNode?.replaceChild(newInput, input);

      newInput.addEventListener('input', () => {
        const query = newInput.value;
        buildSuggestions(query);
        window.dispatchEvent(
          new CustomEvent('recipe-search', { detail: { query } })
        );
      });

      newInput.addEventListener('focus', () => buildSuggestions(newInput.value));

      newInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          newInput.blur();
          hideSuggestions();
        }
      });

      document.addEventListener('click', (e) => {
        const target = e.target;
        if (!(target instanceof Node)) return;
        if (!root.contains(target)) hideSuggestions();
      });
    });
  }

  // Initialize on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeRecipeSearch);
  } else {
    initializeRecipeSearch();
  }

  // Reinitialize on Astro page transitions
  document.addEventListener('astro:page-load', initializeRecipeSearch);
  document.addEventListener('astro:after-swap', initializeRecipeSearch);
</script>
