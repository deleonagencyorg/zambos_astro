---
// Este componente ahora es un wrapper que también incluye la detección automática de idioma
// La funcionalidad principal de i18n está en el archivo i18n.ts
import { getLocale, setLocale } from '../../i18n/i18n';
---

<slot />

<script>
  const COOKIE_NAME = 'user_country';
  const LOCALE_COOKIE = 'user_locale';
  const COOKIE_MAX_AGE = 60 * 60 * 24 * 30; // 30 días en segundos
  const VALID_LOCALES = ['us', 'es'];

  const ENGLISH_SPEAKING_COUNTRIES = [
    'US', 'GB', 'CA', 'AU', 'NZ', 'IE', 'ZA', 'JM', 'BZ', 'BS',
    'BB', 'AG', 'DM', 'GD', 'KN', 'LC', 'VC', 'TT', 'GY'
  ];

  function getCookie(name: string): string | null {
    const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
    return match ? decodeURIComponent(match[1]) : null;
  }

  function setCookie(name: string, value: string, maxAge: number) {
    document.cookie = `${name}=${encodeURIComponent(value)}; max-age=${maxAge}; path=/; samesite=lax`;
  }

  function getLocaleFromCountry(countryCode: string | null): 'us' | 'es' {
    if (!countryCode) return 'es';
    return ENGLISH_SPEAKING_COUNTRIES.includes(countryCode.toUpperCase()) ? 'us' : 'es';
  }

  async function detectAndRedirect() {
    const currentSegment = window.location.pathname.split('/')[1];

    // Ya estamos en una ruta válida con locale — solo actualizar cookie si falta
    if (VALID_LOCALES.includes(currentSegment)) {
      if (!getCookie(LOCALE_COOKIE)) {
        setCookie(LOCALE_COOKIE, currentSegment, COOKIE_MAX_AGE);
      }
      return;
    }

    // Verificar si ya tenemos la cookie de país guardada
    const savedCountry = getCookie(COOKIE_NAME);
    if (savedCountry && savedCountry !== 'UNKNOWN') {
      const locale = getLocaleFromCountry(savedCountry);
      setCookie(LOCALE_COOKIE, locale, COOKIE_MAX_AGE);
      const path = window.location.pathname.split('/').slice(2).join('/');
      window.location.replace(`/${locale}/${path}`);
      return;
    }

    // Verificar cookie de locale directamente
    const savedLocale = getCookie(LOCALE_COOKIE);
    if (savedLocale && VALID_LOCALES.includes(savedLocale)) {
      const path = window.location.pathname.split('/').slice(2).join('/');
      window.location.replace(`/${savedLocale}/${path}`);
      return;
    }

    // Primera visita sin cookie — llamar a la API de detección
    try {
      const response = await fetch('/api/detect-locale');
      const data = await response.json();

      const country: string = data.country || 'UNKNOWN';
      const locale: string = data.defaultLocale || 'es';

      setCookie(COOKIE_NAME, country, COOKIE_MAX_AGE);
      setCookie(LOCALE_COOKIE, locale, COOKIE_MAX_AGE);

      const path = window.location.pathname.split('/').slice(2).join('/');
      window.location.replace(`/${locale}/${path}`);
    } catch (error) {
      console.error('Error al detectar idioma:', error);
      window.location.replace('/es/');
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', detectAndRedirect);
  } else {
    detectAndRedirect();
  }
</script>
