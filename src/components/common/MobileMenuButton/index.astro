---
import { t, type Locale } from '../../../i18n/i18n';
import type { HeaderColorConfig } from '../../../config/headerColors';

export interface Props {
  currentLang: Locale;
  headerColorConfig?: HeaderColorConfig;
}

const { currentLang, headerColorConfig } = Astro.props;

// Traducciones
const openMenuLabel = t('menu_labels.open_main_menu', { namespace: 'common', locale: currentLang }) || 'Open main menu';

// SVG Icons
const menuIconSvg = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
</svg>`;

const closeIconSvg = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
</svg>`;

// Usar colores por defecto si no se proporciona configuración
const textColor = headerColorConfig?.textColor || 'text-white';
const hoverTextColor = headerColorConfig?.hoverTextColor || 'hover:text-gray-300';
const hoverBackgroundColor = headerColorConfig?.hoverBackgroundColor || 'hover:bg-blue-800';
---

<!-- Mobile Menu Button (visible up to md, hidden on lg and up) -->
<div class="lg:hidden bg-greenDark">
  <button
    id="mobile-menu-button"
    type="button"
    class={`inline-flex items-center justify-center p-2 rounded-md ${textColor} ${hoverTextColor} ${hoverBackgroundColor} focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white`}
    aria-expanded="false"
    aria-label={openMenuLabel}
  >
    <span class="sr-only">{openMenuLabel}</span>
    <div id="menu-icon-container" class="w-8 h-8 flex items-center justify-center" set:html={menuIconSvg}></div>
  </button>
</div>

<script define:vars={{ astroMenuIconSvg: menuIconSvg, astroCloseIconSvg: closeIconSvg }}>
(function() {
  'use strict';
  
  // Variable global para rastrear si ya se inicializó
  if (window.__mobileMenuInitialized) {
    return;
  }
  window.__mobileMenuInitialized = true;

  // Función para manejar el clic en el botón del menú móvil
  function handleMobileMenuButtonClick(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const menuButton = document.getElementById('mobile-menu-button');
    const menuIconContainer = document.getElementById('menu-icon-container');
    const mobileMenu = document.getElementById('mobile-menu');
    
    if (!mobileMenu || !menuIconContainer || !menuButton) {
      return;
    }
    
    const isCurrentlyHidden = mobileMenu.classList.contains('hidden');
    
    if (isCurrentlyHidden) {
      // Abrir menú
      mobileMenu.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      menuButton.setAttribute('aria-expanded', 'true');
      menuIconContainer.innerHTML = astroCloseIconSvg;
    } else {
      // Cerrar menú
      mobileMenu.classList.add('hidden');
      document.body.style.overflow = '';
      menuButton.setAttribute('aria-expanded', 'false');
      menuIconContainer.innerHTML = astroMenuIconSvg;
    }
  }

  // Función para inicializar el botón del menú móvil
  function initMobileMenuButton() {
    const menuButton = document.getElementById('mobile-menu-button');
    
    if (!menuButton) {
      return;
    }
    
    // Marcar como inicializado
    if (menuButton.hasAttribute('data-menu-initialized')) {
      return;
    }
    menuButton.setAttribute('data-menu-initialized', 'true');
    
    // Agregar event listener usando onclick para garantizar que funcione
    menuButton.onclick = handleMobileMenuButtonClick;
    
    // También agregar event listener tradicional como respaldo
    menuButton.addEventListener('click', handleMobileMenuButtonClick, { capture: true });
  }

  // Función para reinicializar (útil después de navegación)
  function reinitMobileMenuButton() {
    const menuButton = document.getElementById('mobile-menu-button');
    if (menuButton) {
      menuButton.removeAttribute('data-menu-initialized');
      initMobileMenuButton();
    }
  }

  // Inicializar inmediatamente si el DOM está listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMobileMenuButton);
  } else {
    initMobileMenuButton();
  }

  // Reinicializar en eventos de Astro
  document.addEventListener('astro:page-load', reinitMobileMenuButton);
  document.addEventListener('astro:after-swap', reinitMobileMenuButton);
  
  // Asegurar inicialización después de un breve delay (para casos edge)
  setTimeout(initMobileMenuButton, 100);
  setTimeout(initMobileMenuButton, 500);
})();
</script>
