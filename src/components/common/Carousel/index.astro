---
import CarouselSlide from '../CarouselSlide.astro';
import Skeleton from './Skeleton.astro';
import './styles.css';

export interface Props {
  slides: Array<{
    desktop: string;
    mobile: string;
    alt: string;
    title: string;
    subtitle: string;
    link?: string;
  }>;
  loading?: boolean;
}

const { slides = [], loading = false } = Astro.props;

// Log de depuración


// Identificar la primera imagen para cargarla con prioridad
const firstSlide = slides[0] || {};

// Log del primer slide


// Opcional: Precargar la primera imagen para mejorar el LCP
const preloadFirstImage = true && firstSlide.mobile && firstSlide.desktop;

---

<!-- Importar Swiper desde CDN para garantizar disponibilidad -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
<script is:inline src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

<!-- Importar script para manejo de videos -->
<script is:inline src="/src/components/common/Carousel/videoHandler.js"></script>

<!-- Cargar scripts del carrusel solo en el cliente -->
<script is:inline define:vars={{ carouselSelector: '.swiper-container.main-carousel' }}>
  (function() {
    var mainCarouselInstance = null;

    function initMainCarousel() {
      var container = document.querySelector(carouselSelector);
      if (!container) return;

      if (container.dataset.swiperInitialized === 'true' && mainCarouselInstance) {
        mainCarouselInstance.update();
        return;
      }

      if (mainCarouselInstance) {
        mainCarouselInstance.destroy(true, true);
        mainCarouselInstance = null;
      }

      setTimeout(function() {
        try {
          mainCarouselInstance = new Swiper(carouselSelector, {
            loop: true,
            slidesPerView: 1,
            spaceBetween: 16,
            autoplay: {
              delay: 5000,
              disableOnInteraction: false,
            },
            breakpoints: {
              768: {
                slidesPerView: 2,
                spaceBetween: 16,
              },
              1024: {
                slidesPerView: 3,
                spaceBetween: 20,
              },
            },
            navigation: {
              nextEl: '.swiper-button-next',
              prevEl: '.swiper-button-prev',
            },
            pagination: {
              el: '.swiper-pagination',
              clickable: true,
            },
            touchRatio: 1.5,
            touchAngle: 45,
            touchMoveStopPropagation: true,
            touchStartPreventDefault: false,
            touchStartForcePreventDefault: false,
            threshold: 5,
          });

          container.dataset.swiperInitialized = 'true';
        } catch (error) {
          console.error('Error al inicializar Swiper:', error);
        }
      }, 100);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMainCarousel);
    } else {
      initMainCarousel();
    }

    document.addEventListener('astro:page-load', initMainCarousel);
    document.addEventListener('astro:after-swap', initMainCarousel);
  })();
</script>

{loading ? (
  <Skeleton items={3} />
) : (
  <div class="relative overflow-hidden w-full" transition:animate="fade">
    {preloadFirstImage && (
      <>
        <!-- Precargar la primera imagen para dispositivos móviles -->
        <link rel="preload" href={firstSlide.mobile} as="image" media="(max-width: 767px)">
        <!-- Precargar la primera imagen para escritorio -->
        <link rel="preload" href={firstSlide.desktop} as="image" media="(min-width: 768px)">
      </>
    )}
    
    <!-- Swiper container -->
    <div class="swiper-container main-carousel">
      <div class="swiper-wrapper">
        {slides.map((slide, index) => (
          <CarouselSlide 
            slide={{
              desktop: slide.desktop,
              mobile: slide.mobile,
              alt: slide.alt || "Zambos",
              title: slide.title || '',
              subtitle: slide.subtitle || '',
              link: slide.link || ''
            }}
            priority={index === 0}
          />
        ))}
      </div>
      
      <!-- Controles de navegación -->
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-pagination"></div>
    </div>
  </div>
)}
