---
import { Image } from 'astro:assets';

interface SlideItem {
  desktop: string;
  mobile: string;
  alt: string;
  title?: string;
  subtitle?: string;
  description?: string;
  link?: string;
}

interface Props {
  slides: SlideItem[];
  height?: string;
  mobileHeight?: string;
  tabletHeight?: string;
  overlayOpacity?: string;
  textColor?: string;
  showOverlay?: boolean;
  fitMode?: 'cover' | 'contain';
}

const {
  slides = [],
  height = "100vh",
  mobileHeight = "400px",
  tabletHeight = "600px",
  overlayOpacity = "50",
  textColor = "text-white",
  showOverlay = true,
  fitMode = "contain"
} = Astro.props;
---

<div class="video-carousel-container">
  <div class="swiper-container video-carousel">
    <div class="swiper-wrapper">
      {slides.map((slide, index) => {
        const isVideo = slide.desktop?.toLowerCase().endsWith('.mp4') || 
                       slide.desktop?.toLowerCase().endsWith('.webm');
        const slideId = `slide-${index}`;
        
        return (
          <div class="swiper-slide" id={slideId}>
            <div class="slide-content">
              {isVideo ? (
                <div class="video-container">
                  <video 
                    autoplay 
                    muted 
                    loop 
                    playsinline
                    class="slide-video"
                    data-slide-id={slideId}
                    preload={index === 0 ? "auto" : "metadata"}
                  >
                    <source src={slide.desktop} type={slide.desktop.toLowerCase().endsWith('.webm') ? 'video/webm' : 'video/mp4'}>
                    Your browser does not support the video tag.
                  </video>
                </div>
              ) : (
                <>
                  <!-- Mobile: 0px hasta 768px -->
                  <div 
                    class="image-wrapper mobile-only"
                    data-fit={fitMode}
                  >
                    <img 
                      src={slide.mobile || slide.desktop} 
                      alt={slide.alt || "Slide background"} 
                      class="slide-image ml-[50px]"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </div>

                  <!-- Tablet: 768px hasta 1024px -->
                  <div 
                    class="image-wrapper tablet-only"
                    style={`height: ${tabletHeight};`}
                    data-fit={fitMode}
                  >
                    <img 
                      src={slide.desktop} 
                      alt={slide.alt || "Slide background"} 
                      class="slide-image ml-[100px]"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </div>

                  <!-- Desktop: 1024px en adelante -->
                  <div 
                    class="image-wrapper desktop-only z-0"
                    style={`height: ${height};`}
                    data-fit={fitMode}
                  >
                    <img 
                      src={slide.desktop} 
                      alt={slide.alt || "Slide background"} 
                      class="slide-image ml-[100px]"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </div>

                  <div class="absolute z-30 top-[40px] -left-[5px] hidden lg:block">
                    <img 
                      src='/images/es/chicharrones.png'
                      alt={"chicharrones"} 
                      class="w-[100px] h-[200px]"
                      loading={index === 0 ? "eager" : "lazy"}
                      >
                  </div>

                  <div class="absolute z-30 top-[400px] right-[0px] hidden lg:block">
                    <img 
                      src='/images/es/tajin.png'
                      alt={"chicharrones"} 
                      class="w-[100px] h-[200px]"
                      loading={index === 0 ? "eager" : "lazy"}
                      >
                  </div>

                  <div
                  class="absolute z-30 top-[650px] right-[50px]  hidden lg:block"
                  >
                    <div class="flex flex-col gap-5">
                      <button class="bg-[#FF0001] p-[15px] rounded-full">
                        <svg width="30" height="30" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M7.56281 11.3433C7.56281 9.25511 9.25511 7.5619 11.3433 7.5619C13.4315 7.5619 15.1247 9.25511 15.1247 11.3433C15.1247 13.4315 13.4315 15.1247 11.3433 15.1247C9.25511 15.1247 7.56281 13.4315 7.56281 11.3433ZM5.51865 11.3433C5.51865 14.5603 8.12634 17.168 11.3433 17.168C14.5603 17.168 17.168 14.5603 17.168 11.3433C17.168 8.12634 14.5603 5.51865 11.3433 5.51865C8.12634 5.51865 5.51865 8.12634 5.51865 11.3433ZM16.0374 5.2877C16.0373 5.55692 16.117 5.82012 16.2664 6.04404C16.4159 6.26794 16.6285 6.4425 16.8771 6.54562C17.1258 6.64874 17.3995 6.67582 17.6636 6.6234C17.9276 6.57098 18.1703 6.44143 18.3606 6.25115C18.5511 6.06085 18.6808 5.81836 18.7335 5.55434C18.7861 5.29031 18.7592 5.01661 18.6563 4.76784C18.5534 4.51908 18.379 4.30642 18.1552 4.15675C17.9315 4.0071 17.6683 3.92716 17.399 3.92705C17.0381 3.92722 16.6917 4.07061 16.4364 4.32573C16.1812 4.58084 16.0376 4.92684 16.0374 5.2877ZM6.76061 20.5765C5.65468 20.5262 5.05358 20.3419 4.65411 20.1863C4.12452 19.9801 3.74665 19.7345 3.34936 19.3378C2.95207 18.941 2.70615 18.5635 2.50088 18.0339C2.34516 17.6346 2.16094 17.0333 2.11067 15.9275C2.05568 14.7318 2.0447 14.3726 2.0447 11.3434C2.0447 8.31419 2.05659 7.95601 2.11067 6.75934C2.16104 5.65341 2.34661 5.0533 2.50088 4.65284C2.70706 4.12324 2.95262 3.74538 3.34936 3.34809C3.7461 2.9508 4.12361 2.70488 4.65411 2.49961C5.0534 2.34389 5.65468 2.15967 6.76061 2.1094C7.95628 2.05441 8.31546 2.04343 11.3433 2.04343C14.3712 2.04343 14.7306 2.05532 15.9274 2.1094C17.0333 2.15976 17.6334 2.34534 18.0338 2.49961C18.5634 2.70488 18.9413 2.95135 19.3386 3.34809C19.7359 3.74483 19.9809 4.12324 20.1871 4.65284C20.3428 5.05212 20.5271 5.65341 20.5773 6.75934C20.6323 7.95601 20.6432 8.31419 20.6432 11.3434C20.6432 14.3726 20.6323 14.7308 20.5773 15.9275C20.527 17.0333 20.3418 17.6345 20.1871 18.0339C19.9809 18.5635 19.7353 18.9414 19.3386 19.3378C18.9418 19.7342 18.5634 19.9801 18.0338 20.1863C17.6345 20.3419 17.0333 20.5262 15.9274 20.5765C14.7317 20.6314 14.3725 20.6424 11.3433 20.6424C8.3141 20.6424 7.95592 20.6314 6.76061 20.5765ZM6.66669 0.068695C5.45912 0.123687 4.63397 0.315162 3.91335 0.595569C3.16705 0.88514 2.53527 1.27363 1.90395 1.90395C1.27263 2.53427 0.88514 3.16705 0.595569 3.91335C0.315162 4.63442 0.123687 5.45912 0.068695 6.66668C0.0127952 7.87615 0 8.26282 0 11.3433C0 14.4238 0.0127952 14.8105 0.068695 16.0199C0.123687 17.2275 0.315162 18.0522 0.595569 18.7733C0.88514 19.5191 1.27272 20.1526 1.90395 20.7826C2.53518 21.4127 3.16705 21.8007 3.91335 22.0911C4.63533 22.3715 5.45912 22.563 6.66669 22.6179C7.87679 22.6729 8.26282 22.6866 11.3433 22.6866C14.4238 22.6866 14.8105 22.6738 16.0199 22.6179C17.2275 22.563 18.0522 22.3715 18.7733 22.0911C19.5191 21.8007 20.1514 21.413 20.7826 20.7826C21.414 20.1523 21.8007 19.5191 22.0911 18.7733C22.3715 18.0522 22.5639 17.2275 22.6179 16.0199C22.6729 14.8096 22.6857 14.4238 22.6857 11.3433C22.6857 8.26282 22.6729 7.87615 22.6179 6.66668C22.563 5.45903 22.3715 4.63397 22.0911 3.91335C21.8007 3.1675 21.413 2.53527 20.7826 1.90395C20.1523 1.27263 19.5191 0.88514 18.7742 0.595569C18.0522 0.315162 17.2275 0.12278 16.0208 0.068695C14.8114 0.0137027 14.4247 0 11.3442 0C8.26373 0 7.87679 0.0127952 6.66669 0.068695Z" fill="white"/>
                        </svg>
                      </button>
                      <button class="bg-[#FF0001] p-[15px] rounded-full">
                        <svg width="30" height="30" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M10.8896 0C16.9038 0 21.7791 4.87542 21.7791 10.8896C21.7791 16.3249 17.7969 20.8299 12.5911 21.6469V14.0374H15.1284L15.6112 10.8896L12.5911 10.8892V8.84684C12.5911 8.84009 12.5911 8.83344 12.5912 8.82669C12.5912 8.81657 12.5914 8.80655 12.5915 8.79642C12.6079 7.95323 13.0394 7.14628 14.3656 7.14628H15.7388V4.46642C15.7388 4.46642 14.4926 4.25331 13.3012 4.25331C10.8525 4.25331 9.23893 5.71426 9.18927 8.36345C9.18851 8.40538 9.18808 8.44752 9.18808 8.48999V10.8892H6.42315V14.0369L9.18808 14.0374V21.6464C3.98216 20.8295 0 16.3249 0 10.8896C0 4.87542 4.87542 0 10.8896 0Z" fill="white"/>
                        </svg>
                      </button>
                      <button class="bg-[#FF0001] p-[15px] rounded-full">
                        <svg width="30" height="30" viewBox="0 0 20 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M10.3514 0.0189093C11.5898 -1.26771e-08 12.8186 0.00944897 14.0474 0C14.1231 1.44625 14.643 2.92087 15.7017 3.94175C16.7604 4.991 18.2539 5.47307 19.7096 5.63376V9.44318C18.3484 9.39588 16.9777 9.1123 15.7395 8.52626C15.2007 8.28051 14.6997 7.96857 14.2082 7.64717C14.1988 10.4074 14.2176 13.1675 14.1892 15.9183C14.1137 17.2416 13.6788 18.5555 12.9131 19.6425C11.6749 21.4574 9.52905 22.6391 7.32664 22.6768C5.97492 22.7525 4.62318 22.3839 3.46996 21.7033C1.56053 20.5783 0.218268 18.5177 0.0197608 16.3058C0.000851472 15.8332 -0.00859763 15.3605 0.0103003 14.8974C0.18045 13.1014 1.069 11.381 2.44909 10.2089C4.01823 8.84766 6.21122 8.19543 8.26246 8.58298C8.28129 9.98199 8.22457 11.381 8.22457 12.7799C7.28882 12.4775 6.19232 12.5626 5.36994 13.1298C4.77443 13.5172 4.32071 14.1128 4.08437 14.784C3.88587 15.266 3.94259 15.7953 3.95205 16.3058C4.17892 17.8561 5.67242 19.1604 7.26046 19.0187C8.31918 19.0092 9.33055 18.3949 9.87888 17.4968C10.0584 17.1849 10.257 16.8635 10.2664 16.4949C10.361 14.8028 10.3231 13.1202 10.3326 11.4283C10.342 7.61881 10.3231 3.81885 10.3514 0.0189093Z" fill="white"/>
                        </svg>
                      </button>
                    </div>
                  </div>

                </>
              )}
              
              {showOverlay && (slide.title || slide.subtitle) && (
                <div class={`overlay bg-black bg-opacity-${overlayOpacity}`}>
                  <div class="text-content">
                    {slide.title && <h1 class={`slide-title ${textColor}`}>{slide.title}</h1>}
                    {slide.subtitle && <p class={`slide-subtitle ${textColor}`}>{slide.subtitle}</p>}
                    {slide.link && (
                      <a href={slide.link} class="slide-link">
                        <span>Ver más</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <line x1="5" y1="12" x2="19" y2="12"></line>
                          <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                      </a>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>
    
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>

<style>
  /* Navigation styles */
  :global(.swiper-button-next),
  :global(.swiper-button-prev) {
    color: white !important;
    filter: drop-shadow(0px 0px 3px rgba(0, 0, 0, 0.5));
  }
  
  :global(.swiper-pagination-bullet) {
    background: white !important;
    opacity: 0.7;
  }
  
  :global(.swiper-pagination-bullet-active) {
    opacity: 1;
    background: white !important;
  }
  
  /* Container styles */
  .video-carousel-container {
    position: relative;
    width: 100%;
    overflow: hidden;
  }
  
  .slide-content {
    position: relative;
    width: 100%;
  }

  /* Image wrapper con fondo */
  .image-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
    background: #0DB04A;
    align-items: center;
    justify-content: center;
  }
  
  /* Responsive visibility - SOLUCIÓN AL PROBLEMA */
  .mobile-only {
    display: flex;
    height: 400px;
  }

  .tablet-only,
  .desktop-only {
    display: none;
  }

  @media (min-width: 768px) {
    .mobile-only {
      display: none;
    }
    
    .tablet-only {
      display: flex;
    }
  }

  @media (min-width: 1024px) {
    .tablet-only {
      display: none;
    }
    
    .desktop-only {
      display: flex;
    }
  }
  
  /* Imagen que se ajusta al contenedor */
  .slide-image {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* Modo contain: muestra la imagen completa */
  .image-wrapper[data-fit="contain"] .slide-image {
    object-fit: contain;
    object-position: center;
  }

  /* Modo cover: recorta la imagen para llenar el espacio */
  .image-wrapper[data-fit="cover"] .slide-image {
    object-fit: cover;
    object-position: center;
  }
  
  /* Video container */
  .video-container {
    position: relative;
    width: 100%;
    height: 100vh;
  }
  
  .slide-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  /* Overlay */
  .overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 3;
  }
  
  .text-content {
    text-align: center;
    padding: 0 1rem;
    max-width: 800px;
  }
  
  .slide-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }
  
  .slide-subtitle {
    font-size: 1.25rem;
    font-weight: 400;
    margin-bottom: 2rem;
  }
  
  .slide-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 9999px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .slide-link:hover {
    background-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }
  
  /* Responsive adjustments */
  @media (min-width: 768px) {
    .slide-title {
      font-size: 2.5rem;
    }
    
    .slide-subtitle {
      font-size: 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .slide-title {
      font-size: 3.5rem;
    }
    
    .slide-subtitle {
      font-size: 2rem;
    }
  }

  /* Video responsive heights */
  @media (max-width: 767px) {
    .video-container {
      height: 400px;
    }
  }

  @media (min-width: 768px) and (max-width: 1023px) {
    .video-container {
      height: 600px;
    }
  }
</style>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination, Autoplay } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';
  import 'swiper/css/pagination';
  
  document.addEventListener('DOMContentLoaded', () => {
    const swiper = new Swiper('.video-carousel', {
      modules: [Navigation, Pagination, Autoplay],
      slidesPerView: 1,
      spaceBetween: 0,
      loop: true,
      autoplay: {
        delay: 5000,
        disableOnInteraction: false,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
    });
    
    const videos = document.querySelectorAll('.slide-video');
    
    function playVideo(video) {
      if (!video) return;
      
      const playPromise = video.play();
      
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            console.log('Video playing');
          })
          .catch(error => {
            console.warn('Video playback was prevented:', error);
          });
      }
    }
    
    function pauseAllVideos() {
      videos.forEach(video => {
        video.pause();
      });
    }
    
    swiper.on('slideChange', () => {
      pauseAllVideos();
      
      const activeSlide = swiper.slides[swiper.activeIndex];
      const activeVideo = activeSlide?.querySelector('.slide-video');
      
      if (activeVideo) {
        setTimeout(() => playVideo(activeVideo), 300);
      }
    });
    
    const initialVideo = swiper.slides[swiper.activeIndex]?.querySelector('.slide-video');
    if (initialVideo) {
      playVideo(initialVideo);
    }
  });
</script>