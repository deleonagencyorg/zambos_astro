---
import { Image } from 'astro:assets';

interface SlideItem {
  desktop: string;
  mobile: string;
  alt: string;
  title?: string;
  subtitle?: string;
  description?: string;
  link?: string;
}

interface Props {
  slides: SlideItem[];
  height?: string;
  mobileHeight?: string;
  tabletHeight?: string;
  overlayOpacity?: string;
  textColor?: string;
  showOverlay?: boolean;
  fitMode?: 'cover' | 'contain';
}

const {
  slides = [],
  height = "800px",
  mobileHeight = "400px",
  tabletHeight = "600px",
  overlayOpacity = "50",
  textColor = "text-white",
  showOverlay = true,
  fitMode = "contain"
} = Astro.props;
---

<div class="video-carousel-container">
  <div class="swiper-container video-carousel">
    <div class="swiper-wrapper">
      {slides.map((slide, index) => {
        const isVideo = slide.desktop?.toLowerCase().endsWith('.mp4') || 
                       slide.desktop?.toLowerCase().endsWith('.webm');
        const slideId = `slide-${index}`;
        
        return (
          <div class="swiper-slide" id={slideId}>
            <div class="slide-content">
              {isVideo ? (
                <div class="video-container">
                  <video 
                    autoplay 
                    muted 
                    loop 
                    playsinline
                    class="slide-video"
                    data-slide-id={slideId}
                    preload={index === 0 ? "auto" : "metadata"}
                  >
                    <source src={slide.desktop} type={slide.desktop.toLowerCase().endsWith('.webm') ? 'video/webm' : 'video/mp4'}>
                    Your browser does not support the video tag.
                  </video>
                </div>
              ) : slide.link && slide.link !== '#' ? (
                <a href={slide.link} class="slide-link-wrapper">
                  <!-- Mobile: 0px hasta 768px -->
                  <div 
                    class="image-wrapper mobile-only"
                    data-fit={fitMode}
                  >
                    <img 
                      src={slide.mobile || slide.desktop} 
                      alt={slide.alt || "Slide background"} 
                      class="slide-image"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </div>

                  <!-- Tablet: 768px hasta 1024px -->
                  <div 
                    class="image-wrapper tablet-only"
                    style={`height: ${tabletHeight};`}
                    data-fit={fitMode}
                  >
                    <img 
                      src={slide.desktop} 
                      alt={slide.alt || "Slide background"} 
                      class="slide-image"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </div>

                  <!-- Desktop: 1024px en adelante -->
                  <div 
                    class="image-wrapper desktop-only z-0"
                    style={`height: ${height};`}
                    data-fit={fitMode}
                  >
                    <img 
                      src={slide.desktop} 
                      alt={slide.alt || "Slide background"} 
                      class="slide-image"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </div>
                </a>
              ) : (
                <>
                  <!-- Mobile: 0px hasta 768px -->
                  <div 
                    class="image-wrapper mobile-only"
                    data-fit={fitMode}
                  >
                    <img 
                      src={slide.mobile || slide.desktop} 
                      alt={slide.alt || "Slide background"} 
                      class="slide-image"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </div>

                  <!-- Tablet: 768px hasta 1024px -->
                  <div 
                    class="image-wrapper tablet-only"
                    style={`height: ${tabletHeight};`}
                    data-fit={fitMode}
                  >
                    <img 
                      src={slide.desktop} 
                      alt={slide.alt || "Slide background"} 
                      class="slide-image"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </div>

                  <!-- Desktop: 1024px en adelante -->
                  <div 
                    class="image-wrapper desktop-only z-0"
                    style={`height: ${height};`}
                    data-fit={fitMode}
                  >
                    <img 
                      src={slide.desktop} 
                      alt={slide.alt || "Slide background"} 
                      class="slide-image"
                      loading={index === 0 ? "eager" : "lazy"}
                    />
                  </div>
                </>
              )}
              
              {showOverlay && (slide.title || slide.subtitle) && (
                <div class={`overlay bg-black bg-opacity-${overlayOpacity}`}>
                  <div class="text-content">
                    {slide.title && <h1 class={`slide-title ${textColor}`}>{slide.title}</h1>}
                    {slide.subtitle && <p class={`slide-subtitle ${textColor}`}>{slide.subtitle}</p>}
                    {slide.link && (
                      <a href={slide.link} class="slide-link">
                        <span>Ver más</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <line x1="5" y1="12" x2="19" y2="12"></line>
                          <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                      </a>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>
    
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>

<style>
  /* Navigation styles */
  :global(.swiper-button-next),
  :global(.swiper-button-prev) {
    color: white !important;
    filter: drop-shadow(0px 0px 3px rgba(0, 0, 0, 0.5));
  }
  
  :global(.swiper-pagination-bullet) {
    background: white !important;
    opacity: 0.7;
  }
  
  :global(.swiper-pagination-bullet-active) {
    opacity: 1;
    background: white !important;
  }
  
  /* Container styles */
  .video-carousel-container {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  /* Link wrapper for clickable slides */
  .slide-link-wrapper {
    display: block;
    width: 100%;
    height: 100%;
    text-decoration: none;
    cursor: pointer;
  }
  
  .slide-content {
    position: relative;
    width: 100%;
  }

  /* Image wrapper con fondo */
  .image-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
    background: #0DB04A;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Responsive visibility - SOLUCIÓN AL PROBLEMA */
  .mobile-only {
    display: flex;
    height: 550px;
  }

  .tablet-only,
  .desktop-only {
    display: none;
  }

  @media (min-width: 768px) {
    .mobile-only {
      display: none;
    }
    
    .tablet-only {
      display: flex;
    }
  }

  @media (min-width: 1024px) {
    .tablet-only {
      display: none;
    }
    
    .desktop-only {
      display: flex;
    }
  }
  
  /* Imagen que se ajusta al contenedor */
  .slide-image {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
    object-position: center;
  }

  /* Modo contain: muestra la imagen completa */
  .image-wrapper[data-fit="contain"] .slide-image {
    object-fit: contain;
    object-position: center;
  }

  /* Modo cover: recorta la imagen para llenar el espacio */
  .image-wrapper[data-fit="cover"] .slide-image {
    object-fit: cover;
    object-position: center;
  }

  /* Normalize banners by breakpoint:
     - Mobile: fill 100% height (crop overflow)
     - Desktop: fill 100% width (crop overflow)
     These rules override fitMode="contain" when needed.
  */
  .mobile-only[data-fit="contain"] .slide-image,
  .mobile-only[data-fit="cover"] .slide-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .tablet-only[data-fit="contain"] .slide-image,
  .tablet-only[data-fit="cover"] .slide-image,
  .desktop-only[data-fit="contain"] .slide-image,
  .desktop-only[data-fit="cover"] .slide-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }
  
  /* Video container */
  .video-container {
    position: relative;
    width: 100%;
    height: 100vh;
  }
  
  .slide-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  /* Overlay */
  .overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 3;
  }
  
  .text-content {
    text-align: center;
    padding: 0 1rem;
    max-width: 800px;
  }
  
  .slide-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }
  
  .slide-subtitle {
    font-size: 1.25rem;
    font-weight: 400;
    margin-bottom: 2rem;
  }
  
  .slide-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 9999px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .slide-link:hover {
    background-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }
  
  /* Responsive adjustments */
  @media (min-width: 768px) {
    .slide-title {
      font-size: 2.5rem;
    }
    
    .slide-subtitle {
      font-size: 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .slide-title {
      font-size: 3.5rem;
    }
    
    .slide-subtitle {
      font-size: 2rem;
    }
  }

  /* Video responsive heights */
  @media (max-width: 767px) {
    .video-container {
      height: 400px;
    }
  }

  @media (min-width: 768px) and (max-width: 1023px) {
    .video-container {
      height: 600px;
    }
  }

  /* Custom mobile range: 314px to 517px */
  @media (min-width: 314px) and (max-width: 517px) {
    /* Ensure non-video mobile slides have 550px height */
    .mobile-only {
      height: 550px;
    }

    /* Ensure video slides also have 500px height */
    .video-container {
      height: 500px;
    }

    /* Make images fill height and stay centered */
    .image-wrapper .slide-image {
      height: 100%;
      width: 100%;
      object-fit: cover;
      object-position: center;
    }
  }
</style>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination, Autoplay } from 'swiper/modules';
  import 'swiper/css';
  import 'swiper/css/navigation';
  import 'swiper/css/pagination';
  
  document.addEventListener('DOMContentLoaded', () => {
    const swiper = new Swiper('.video-carousel', {
      modules: [Navigation, Pagination, Autoplay],
      slidesPerView: 1,
      spaceBetween: 0,
      loop: true,
      autoplay: {
        delay: 5000,
        disableOnInteraction: false,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
    });
    
    const videos = document.querySelectorAll<HTMLVideoElement>('.slide-video');
    
    function playVideo(video: HTMLVideoElement | null) {
      if (!video) return;
      
      const playPromise = video.play();
      
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            console.log('Video playing');
          })
          .catch((error: unknown) => {
            console.warn('Video playback was prevented:', error);
          });
      }
    }
    
    function pauseAllVideos() {
      videos.forEach(video => {
        video.pause();
      });
    }
    
    swiper.on('slideChange', () => {
      pauseAllVideos();
      
      const activeSlide = swiper.slides[swiper.activeIndex];
      const activeVideo = activeSlide?.querySelector('.slide-video') as HTMLVideoElement | null;
      
      if (activeVideo) {
        setTimeout(() => playVideo(activeVideo), 300);
      }
    });
    
    const initialVideo = swiper.slides[swiper.activeIndex]?.querySelector('.slide-video') as HTMLVideoElement | null;
    if (initialVideo) {
      playVideo(initialVideo);
    }
  });
</script>